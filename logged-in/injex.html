<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Injex Launcher</title>
    <meta name="description" content="Server selection and launcher for Injex.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Using FontAwesome 6.5.2 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../injector.js"></script>

    <style>
        /* --- FONT & BASE STYLING --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #040404; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            overflow-x: hidden;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* --- UI COMPONENTS --- */
        .btn-toolbar-style {
            background: var(--menu-bg, #000000);
            border: 1px solid var(--menu-border, #333);
            border-radius: 0.75rem;
            color: var(--menu-text, #d1d5db);
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: var(--menu-item-hover-bg, #2a2a2a);
            border-color: var(--menu-border, #fff);
            color: #ffffff;
        }
        
        .btn-primary {
            /* Adjusted to be a strong call-to-action */
            background-color: #4f46e5;
            border: 1px solid #4f46e5;
            color: white;
            padding: 0.5rem 1.5rem;
        }
        .btn-primary:hover {
            background-color: #6366f1;
            border-color: #6366f1;
            color: white;
        }

        /* Server Card Styling */
        .server-card {
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            margin-bottom: 0.75rem;
        }
        .server-card:hover {
            border-color: #333;
            background-color: #141414;
        }

        /* Status Badges */
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .badge.ok {
            background-color: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.2);
        }
        .badge.bad {
            background-color: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border-color: rgba(239, 68, 68, 0.2);
        }
        .badge.test {
            /* Used for Testing and now Unknown (Blocked) */
            background-color: rgba(234, 179, 8, 0.1);
            color: #facc15;
            border-color: rgba(234, 179, 8, 0.2);
        }

        /* --- ANIMATIONS --- */
        @keyframes fade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-item {
            opacity: 0;
            animation: fade 0.4s forwards;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-[#040404] flex items-center justify-center z-50">
        <i class="fa-solid fa-spinner fa-spin fa-2x text-gray-500"></i>
    </div>

    <div id="page-content" class="hidden flex-col min-h-screen">
        
        <!-- Header -->
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">Injex Launcher</h1>
            
            <div class="flex items-center gap-2">
                <div class="text-xs text-gray-500 mr-2 hidden md:block" id="status-text">Scanning mirrors...</div>
                <button id="toggle-manual" class="btn-toolbar-style">
                    <i id="manual-icon" class="fa-solid fa-list"></i>
                    <span id="manual-text">Show All</span>
                </button>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="sticky top-0 z-10 bg-[#040404]/80 backdrop-blur-md border-b border-[#1a1a1a] px-6 py-2 flex justify-between items-center text-sm text-gray-400">
            <div class="flex gap-4">
                <span>Total: <strong id="count-total" class="text-white font-normal">0</strong></span>
                <span class="text-[#333]">|</span>
                <span>Active: <strong id="count-active" class="text-green-400 font-normal">0</strong></span>
            </div>
            <button id="refresh-btn" class="hover:text-white transition-colors" title="Restart Scan">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>

        <!-- Main Content -->
        <div class="flex-grow p-6 max-w-4xl mx-auto w-full">
            
            <!-- Spinner / Status Area -->
            <div id="spinner-container" class="flex flex-col items-center justify-center py-20">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-[#ff8c00] mb-4"></i>
                <p class="text-gray-500">Testing connections...</p>
            </div>

            <!-- Auto Launch Card (Black box, light grey outline, with padding) -->
            <div id="auto-launch-container" class="hidden flex-col items-center justify-center p-8 bg-[#040404] border border-[#2a2a2a] rounded-2xl mb-8 shadow-lg">
                <div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center mb-4 text-green-400 border border-green-500/20">
                    <i class="fa-solid fa-bolt text-2xl"></i>
                </div>
                <h2 class="text-xl text-white mb-2">Fastest Server Found</h2>
                <p class="text-gray-500 mb-6 text-sm text-center">Ready to launch secure connection.</p>
                <button id="auto-launch-btn" class="btn-primary flex items-center gap-2 rounded-lg font-medium transition-colors">
                    <i class="fa-solid fa-rocket"></i> Launch Now
                </button>
            </div>

            <!-- Server List -->
            <div id="server-list" class="hidden">
                <!-- Server cards injected here -->
            </div>
            
            <!-- No Servers Error -->
            <div id="no-servers-msg" class="hidden text-center text-red-400 py-10">
                <i class="fa-solid fa-circle-exclamation mb-2"></i>
                <p>No active servers found. Please check your connection.</p>
                <p class="text-xs text-gray-600 mt-2">Try Manual Mode to force connection.</p>
            </div>
        </div>
    </div>

    <!-- Preview Overlay (Non-interactive URL display) -->
    <div id="preview-overlay" class="fixed inset-0 bg-black/95 flex flex-col z-50 hidden">
        <div id="preview-header" class="p-4 bg-[#040404] border-b border-[#1a1a1a] flex justify-between items-center">
            <div class="text-sm text-gray-400 flex items-center">
                <i class="fa-solid fa-eye text-indigo-400 mr-2"></i> 
                <span>Preview Mode (Non-Interactive)</span>
            </div>
            <button id="close-preview" class="btn-toolbar-style text-xs">
                <i class="fa-solid fa-xmark"></i> Close
            </button>
        </div>
        
        <!-- URL Display Area -->
        <div id="preview-content" class="p-6 flex-grow overflow-auto bg-black flex flex-col items-center">
            <div class="max-w-xl w-full">
                <h3 class="text-white text-lg mb-4 font-medium">Server Connection Target URL</h3>
                <div id="preview-url-display" class="bg-[#111] p-4 rounded-lg font-mono text-sm break-all text-gray-300 shadow-inner border border-[#1a1a1a]">
                    <!-- URL will be inserted here -->
                </div>
                <p class="text-sm text-gray-500 mt-6 text-center">
                    Content is not displayed here to ensure connection stability. Use the 'Launch' button to securely access the server.
                </p>
            </div>
        </div>
    </div>

    <script>
        // --- AUTHENTICATION ---
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        
        // Simulating the auth check structure. 
        function initializeAuth() {
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                pageContent.classList.remove('hidden');
                pageContent.style.display = 'flex';
            }, 300);
        }
        initializeAuth();

        // --- SERVER TEST LOGIC ---
        
        const mirrors = [
          "https://8021688600113732413547102395624276084104729385610293875616.estoniaeducation.info/",
          "https://8021688600113732413547102395624276084104729385613928573282.educationandtraining.info/",
          "https://8021688600113732483727102395624276084104729385610293875616.foothillsbible.org/",
          "https://8021688600113732413547102395624276482734729385610293875616.smarthomesllc.org/",
          "https://8021688600113732413547102302937276084104729385610293875616.wilcorw.org/",
          "https://8021688600113732413547102395624276084104208565610293875616.alertconference.org/",
        ];

        const expectedTitle = "Injex";
        const tokens = mirrors.map(() => Math.random().toString(36).slice(2));
        const results = mirrors.map((u, i) => ({
            id: i,
            label: `Server ${i + 1}`,
            origin: u,
            status: "testing" // testing, unblocked, blocked
        }));
        
        let frames = new Array(mirrors.length).fill(null);
        let timers = new Array(mirrors.length).fill(null);
        let firstActiveOrigin = null;

        // UI Elements
        const listEl = document.getElementById('server-list');
        const spinnerEl = document.getElementById('spinner-container');
        const autoLaunchEl = document.getElementById('auto-launch-container');
        const autoLaunchBtn = document.getElementById('auto-launch-btn');
        const noServersMsg = document.getElementById('no-servers-msg');
        const countTotalEl = document.getElementById('count-total');
        const countActiveEl = document.getElementById('count-active');
        const toggleManualBtn = document.getElementById('toggle-manual');
        const manualText = document.getElementById('manual-text');
        const refreshBtn = document.getElementById('refresh-btn');
        const statusText = document.getElementById('status-text');
        
        // Preview Elements (Updated for non-interactive display)
        const previewOverlay = document.getElementById('preview-overlay');
        const previewUrlDisplay = document.getElementById('preview-url-display');
        const closePreviewBtn = document.getElementById('close-preview');

        // State
        let manualMode = localStorage.getItem("injex_manual_mode") === "1";
        
        function init() {
            countTotalEl.textContent = mirrors.length;
            applyManualMode();
            renderList();
            startTests();
        }

        function applyManualMode() {
            if (manualMode) {
                spinnerEl.classList.add('hidden');
                listEl.classList.remove('hidden');
                manualText.textContent = "Hide All";
                // If we found a server, show auto launch too
                if (firstActiveOrigin) autoLaunchEl.classList.remove('hidden');
            } else {
                // Auto mode
                if (firstActiveOrigin) {
                    spinnerEl.classList.add('hidden');
                    autoLaunchEl.classList.remove('hidden');
                    listEl.classList.add('hidden');
                } else {
                    spinnerEl.classList.remove('hidden');
                    listEl.classList.add('hidden');
                    autoLaunchEl.classList.add('hidden');
                }
                manualText.textContent = "Show All";
            }
            localStorage.setItem("injex_manual_mode", manualMode ? "1" : "0");
        }

        toggleManualBtn.addEventListener('click', () => {
            manualMode = !manualMode;
            applyManualMode();
        });

        refreshBtn.addEventListener('click', () => {
            location.reload();
        });

        function renderList() {
            listEl.innerHTML = '';
            let activeCount = 0;

            results.forEach((r, index) => {
                if (r.status === 'unblocked') activeCount++;

                const card = document.createElement('div');
                card.className = 'server-card fade-in-item';
                card.style.animationDelay = `${index * 0.05}s`;

                let badgeClass, badgeIcon, badgeText, launchDisabled;

                if (r.status === 'unblocked') {
                    badgeClass = 'ok';
                    badgeIcon = 'fa-check';
                    badgeText = 'Ready';
                    launchDisabled = false;
                } else if (r.status === 'blocked') {
                    // MODIFIED: Treat blocked as 'Unknown' and enable launch
                    badgeClass = 'test'; // Yellow
                    badgeIcon = 'fa-question'; // Question mark for unknown
                    badgeText = 'Unknown';
                    launchDisabled = false; // Enabled launch
                } else { // status === 'testing'
                    badgeClass = 'test';
                    badgeIcon = 'fa-circle-notch fa-spin';
                    badgeText = 'Testing';
                    launchDisabled = true; // Disabled launch
                }

                const launchBtnClasses = launchDisabled 
                    ? 'opacity-50 cursor-not-allowed pointer-events-none' 
                    : '';


                card.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-3">
                            <span class="font-medium text-white">${r.label}</span>
                            <span class="badge ${badgeClass}">
                                <i class="fa-solid ${badgeIcon} text-[10px]"></i> ${badgeText}
                            </span>
                        </div>
                        <div class="text-xs text-gray-600 font-mono">ID: ${tokens[r.id]}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn-toolbar-style text-xs" onclick="previewServer('${r.origin}')" title="View Server URL">
                            <i class="fa-solid fa-eye"></i> Preview
                        </button>
                        <button class="btn-toolbar-style text-xs btn-primary ${launchBtnClasses}" onclick="launchServer('${r.origin}')">
                            <i class="fa-solid fa-rocket"></i> Launch
                        </button>
                    </div>
                `;
                listEl.appendChild(card);
            });

            countActiveEl.textContent = activeCount;
        }

        // --- TESTING ENGINE ---

        function cleanupOne(i) {
            if (timers[i]) {
                clearTimeout(timers[i]);
                timers[i] = null;
            }
            if (frames[i]) {
                frames[i].remove();
                frames[i] = null;
            }
        }

        function finalizeIfDone() {
            const allDone = results.every(r => r.status !== 'testing');
            if (allDone && !firstActiveOrigin) {
                spinnerEl.classList.add('hidden');
                noServersMsg.classList.remove('hidden');
                statusText.textContent = "No active servers found";
                // Force manual mode to show user the blocked list
                if (!manualMode) {
                    manualMode = true; 
                    applyManualMode();
                }
            }
        }

        function startTests() {
            const timeoutMs = 2500;
            mirrors.forEach((host, i) => {
                const f = document.createElement('iframe');
                f.style.display = 'none';
                document.body.appendChild(f);
                frames[i] = f;
                
                timers[i] = setTimeout(() => {
                    if (results[i].status === 'testing') {
                        results[i].status = 'blocked';
                        renderList();
                        cleanupOne(i);
                        finalizeIfDone();
                    }
                }, timeoutMs);

                try {
                    const u = new URL(host);
                    u.hash = "injex=" + tokens[i];
                    f.src = u.toString();
                } catch (e) {
                    console.error("Invalid URL", host);
                }
            });
        }

        window.addEventListener("message", function (e) {
            const d = e.data || {};
            if (d.type !== "injex:ready") return;
            if (d.title !== expectedTitle) return;
            
            const idx = tokens.indexOf(d.token);
            if (idx < 0) return;
            
            cleanupOne(idx);
            
            const origin = new URL(mirrors[idx]).origin + "/";
            results[idx].status = "unblocked";
            results[idx].origin = origin;
            
            if (!firstActiveOrigin) {
                firstActiveOrigin = origin;
                statusText.textContent = "Ready";
                // Update Auto Launch UI
                autoLaunchBtn.onclick = () => launchServer(firstActiveOrigin);
                
                if (!manualMode) {
                    applyManualMode(); // Shows auto launch
                }
            }
            
            renderList();
            finalizeIfDone();
        });

        // --- PREVIEW & LAUNCH LOGIC (CLOAKING) ---

        // 1. Preview Logic: Shows non-interactive URL overlay
        window.previewServer = function(url) {
            previewUrlDisplay.textContent = url;
            previewOverlay.style.display = 'flex';
        };

        closePreviewBtn.addEventListener('click', () => {
            previewOverlay.style.display = 'none';
            previewUrlDisplay.textContent = '';
        });

        // 2. Launch Logic: Redirects to about:blank then sends this page to dashboard
        window.launchServer = function(url) {
            // Open about:blank in new tab
            const win = window.open('about:blank', '_blank');
            
            if (win) {
                // Cloak the URL inside about:blank with a browser bar simulation (Change 3)
                const html = `
                    <!DOCTYPE html>
                    <html style="margin:0;height:100%;overflow:hidden;">
                    <head>
                        <title>Dashboard</title>
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
                    </head>
                    <body style="margin:0;height:100%;overflow:hidden; display: flex; flex-direction: column;">
                        <!-- Custom Browser Bar -->
                        <div style="background-color: #000; color: #fff; padding: 0.5rem 1rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #333; flex-shrink: 0; font-family: 'Geist', sans-serif;">
                            <div style="display: flex; gap: 8px; font-size: 14px;">
                                <!-- Mock Tabs -->
                                <span style="background-color: #1a1a1a; padding: 4px 10px; border-radius: 6px 6px 0 0; border: 1px solid #1a1a1a; border-bottom: none; color: #bbb; cursor: default;">Injex Launcher</span>
                                <span style="background-color: #333; padding: 4px 10px; border-radius: 6px 6px 0 0; color: #fff; border: 1px solid #333; border-bottom: none; cursor: default; font-weight: 500;">Server Dashboard</span>
                            </div>
                            <!-- Close Button (Attempts to close window) -->
                            <button onclick="window.close()" style="background-color: #4f46e5; border: none; color: white; padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: background-color 0.2s;">
                                <i class="fa-solid fa-xmark mr-1"></i> Close Tab
                            </button>
                        </div>
                        <!-- Iframe Content (Takes remaining space) -->
                        <iframe src="${url}" style="border:0;width:100%;flex-grow:1; display: block;" allowfullscreen></iframe>
                    </body>
                    </html>
                `;
                win.document.write(html);
                win.document.close();
                
                // Redirect THIS page to dashboard as requested
                window.location.href = 'dashboard.html';
            } else {
                // Using a custom message box instead of alert()
                const msg = document.createElement('div');
                msg.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-[10000]';
                msg.innerHTML = `
                    <div class="bg-[#0d0d0d] p-6 rounded-xl border border-[#2a2a2a] max-w-sm text-center">
                        <h3 class="text-lg text-white mb-3 font-semibold">Action Blocked</h3>
                        <p class="text-gray-400 mb-4">The browser blocked the pop-up window. Please check your settings and try again.</p>
                        <button onclick="this.parentNode.parentNode.remove()" class="btn-primary rounded-lg px-4 py-2 text-sm">Close</button>
                    </div>
                `;
                document.body.appendChild(msg);
            }
        };

        // Start
        init();

    </script>
</body>
</html>
