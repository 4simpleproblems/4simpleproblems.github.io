<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Injex Launcher</title>
    <meta name="description" content="Server selection and launcher for Injex.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Using FontAwesome 6.5.2 to match notes.html -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <style>
        /* --- FONT & BASE STYLING (Matching notes.html) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #040404; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            overflow-x: hidden;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* --- UI COMPONENTS (Adapted from notes.html) --- */
        .btn-toolbar-style {
            background: var(--menu-bg, #000000);
            border: 1px solid var(--menu-border, #333);
            border-radius: 0.75rem;
            color: var(--menu-text, #d1d5db);
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: var(--menu-item-hover-bg, #2a2a2a);
            border-color: var(--menu-border, #fff);
            color: #ffffff;
        }
        
        .btn-primary {
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .btn-primary:hover {
            background-color: rgba(79, 70, 229, 0.2);
            border-color: #6366f1;
            color: #6366f1;
        }

        /* Server Card Styling */
        .server-card {
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            margin-bottom: 0.75rem;
        }
        .server-card:hover {
            border-color: #333;
            background-color: #141414;
        }

        /* Status Badges */
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .badge.ok {
            background-color: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.2);
        }
        .badge.bad {
            background-color: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border-color: rgba(239, 68, 68, 0.2);
        }
        .badge.test {
            background-color: rgba(234, 179, 8, 0.1);
            color: #facc15;
            border-color: rgba(234, 179, 8, 0.2);
        }

        /* --- PREVIEW OVERLAY --- */
        #preview-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
        }
        #preview-frame {
            flex-grow: 1;
            width: 100%;
            border: none;
        }
        #preview-header {
            padding: 1rem;
            background: #040404;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- ANIMATIONS --- */
        @keyframes fade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-item {
            opacity: 0;
            animation: fade 0.4s forwards;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Loading Screen (Matches notes.html) -->
    <div id="loading-screen" class="fixed inset-0 bg-[#040404] flex items-center justify-center z-50">
        <i class="fa-solid fa-spinner fa-spin fa-2x text-gray-500"></i>
    </div>

    <div id="page-content" class="hidden flex-col min-h-screen">
        
        <!-- Header (Matches notes.html structure) -->
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">Injex Launcher</h1>
            
            <div class="flex items-center gap-2">
                <div class="text-xs text-gray-500 mr-2 hidden md:block" id="status-text">Scanning mirrors...</div>
                <button id="toggle-manual" class="btn-toolbar-style">
                    <i id="manual-icon" class="fa-solid fa-list"></i>
                    <span id="manual-text">Show All</span>
                </button>
            </div>
        </header>

        <!-- Stats Bar (Similar to top-stats-bar in notes.html) -->
        <div class="sticky top-0 z-10 bg-[#040404]/80 backdrop-blur-md border-b border-[#1a1a1a] px-6 py-2 flex justify-between items-center text-sm text-gray-400">
            <div class="flex gap-4">
                <span>Total: <strong id="count-total" class="text-white font-normal">0</strong></span>
                <span class="text-[#333]">|</span>
                <span>Active: <strong id="count-active" class="text-green-400 font-normal">0</strong></span>
            </div>
            <button id="refresh-btn" class="hover:text-white transition-colors" title="Restart Scan">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>

        <!-- Main Content -->
        <div class="flex-grow p-6 max-w-4xl mx-auto w-full">
            
            <!-- Spinner / Status Area -->
            <div id="spinner-container" class="flex flex-col items-center justify-center py-20">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-[#ff8c00] mb-4"></i>
                <p class="text-gray-500">Testing connections...</p>
            </div>

            <!-- Auto Launch Card (Shows when a server is found in auto mode) -->
            <div id="auto-launch-container" class="hidden flex-col items-center justify-center py-10 bg-[#0d0d0d] border border-green-900/30 rounded-2xl mb-8">
                <div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center mb-4 text-green-400 border border-green-500/20">
                    <i class="fa-solid fa-bolt text-2xl"></i>
                </div>
                <h2 class="text-xl text-white mb-2">Fastest Server Found</h2>
                <p class="text-gray-500 mb-6 text-sm">Ready to launch secure connection.</p>
                <button id="auto-launch-btn" class="px-6 py-2 bg-white text-black rounded-lg font-medium hover:bg-gray-200 transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-rocket"></i> Launch Now
                </button>
            </div>

            <!-- Server List -->
            <div id="server-list" class="hidden">
                <!-- Server cards injected here -->
            </div>
            
            <!-- No Servers Error -->
            <div id="no-servers-msg" class="hidden text-center text-red-400 py-10">
                <i class="fa-solid fa-circle-exclamation mb-2"></i>
                <p>No active servers found. Please check your connection.</p>
                <p class="text-xs text-gray-600 mt-2">Try Manual Mode to force connection.</p>
            </div>
        </div>
    </div>

    <!-- Preview Overlay -->
    <div id="preview-overlay">
        <div id="preview-header">
            <div class="text-sm text-gray-400 flex items-center">
                <i class="fa-solid fa-eye text-indigo-400 mr-2"></i> 
                <span>Preview Mode</span>
                <span class="text-xs text-gray-600 ml-3">(URL Hidden)</span>
            </div>
            <button id="close-preview" class="btn-toolbar-style text-xs">
                <i class="fa-solid fa-xmark"></i> Close
            </button>
        </div>
        <iframe id="preview-frame" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
    </div>

    <script>
        // --- AUTHENTICATION (Matching notes.html structure) ---
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        
        // Simulating the auth check structure. In production, this uses the injector's auth.
        // We add a slight delay to mimic the loading screen behavior of notes.html
        function initializeAuth() {
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                pageContent.classList.remove('hidden');
                pageContent.style.display = 'flex';
            }, 300);
        }
        initializeAuth();

        // --- SERVER TEST LOGIC (Adapted from original 2.html) ---
        
        const mirrors = [
          "https://8021688600113732413547102395624276084104729385610293875616.estoniaeducation.info/",
          "https://8021688600113732413547102395624276084104729385613928573282.educationandtraining.info/",
          "https://8021688600113732483727102395624276084104729385610293875616.foothillsbible.org/",
          "https://8021688600113732413547102395624276482734729385610293875616.smarthomesllc.org/",
          "https://8021688600113732413547102302937276084104729385610293875616.wilcorw.org/",
          "https://8021688600113732413547102395624276084104208565610293875616.alertconference.org/",
        ];

        const expectedTitle = "Injex";
        const tokens = mirrors.map(() => Math.random().toString(36).slice(2));
        const results = mirrors.map((u, i) => ({
            id: i,
            label: `Server ${i + 1}`,
            origin: u,
            status: "testing" // testing, unblocked, blocked
        }));
        
        let frames = new Array(mirrors.length).fill(null);
        let timers = new Array(mirrors.length).fill(null);
        let firstActiveOrigin = null;

        // UI Elements
        const listEl = document.getElementById('server-list');
        const spinnerEl = document.getElementById('spinner-container');
        const autoLaunchEl = document.getElementById('auto-launch-container');
        const autoLaunchBtn = document.getElementById('auto-launch-btn');
        const noServersMsg = document.getElementById('no-servers-msg');
        const countTotalEl = document.getElementById('count-total');
        const countActiveEl = document.getElementById('count-active');
        const toggleManualBtn = document.getElementById('toggle-manual');
        const manualText = document.getElementById('manual-text');
        const refreshBtn = document.getElementById('refresh-btn');
        const statusText = document.getElementById('status-text');
        
        // Preview Elements
        const previewOverlay = document.getElementById('preview-overlay');
        const previewFrame = document.getElementById('preview-frame');
        const closePreviewBtn = document.getElementById('close-preview');

        // State
        let manualMode = localStorage.getItem("injex_manual_mode") === "1";
        
        function init() {
            countTotalEl.textContent = mirrors.length;
            applyManualMode();
            renderList();
            startTests();
        }

        function applyManualMode() {
            if (manualMode) {
                spinnerEl.classList.add('hidden');
                listEl.classList.remove('hidden');
                manualText.textContent = "Hide List";
                // If we found a server, show auto launch too
                if (firstActiveOrigin) autoLaunchEl.classList.remove('hidden');
            } else {
                // Auto mode
                if (firstActiveOrigin) {
                    spinnerEl.classList.add('hidden');
                    autoLaunchEl.classList.remove('hidden');
                    listEl.classList.add('hidden');
                } else {
                    spinnerEl.classList.remove('hidden');
                    listEl.classList.add('hidden');
                    autoLaunchEl.classList.add('hidden');
                }
                manualText.textContent = "Show All";
            }
            localStorage.setItem("injex_manual_mode", manualMode ? "1" : "0");
        }

        toggleManualBtn.addEventListener('click', () => {
            manualMode = !manualMode;
            applyManualMode();
        });

        refreshBtn.addEventListener('click', () => {
            location.reload();
        });

        function renderList() {
            listEl.innerHTML = '';
            let activeCount = 0;

            results.forEach((r, index) => {
                if (r.status === 'unblocked') activeCount++;

                const card = document.createElement('div');
                card.className = 'server-card fade-in-item';
                card.style.animationDelay = `${index * 0.05}s`;

                // Badge Logic
                let badgeClass = 'test';
                let badgeIcon = 'fa-circle-notch fa-spin';
                let badgeText = 'Testing';

                if (r.status === 'unblocked') {
                    badgeClass = 'ok';
                    badgeIcon = 'fa-check';
                    badgeText = 'Ready';
                } else if (r.status === 'blocked') {
                    badgeClass = 'bad';
                    badgeIcon = 'fa-ban';
                    badgeText = 'Blocked';
                }

                card.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-3">
                            <span class="font-medium text-white">${r.label}</span>
                            <span class="badge ${badgeClass}">
                                <i class="fa-solid ${badgeIcon} text-[10px]"></i> ${badgeText}
                            </span>
                        </div>
                        <div class="text-xs text-gray-600 font-mono">ID: ${tokens[r.id]}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn-toolbar-style text-xs" onclick="previewServer('${r.origin}')" title="Preview Content">
                            <i class="fa-solid fa-eye"></i> Preview
                        </button>
                        <button class="btn-toolbar-style text-xs btn-primary" style="${r.status !== 'unblocked' ? 'opacity:0.5;pointer-events:none;' : ''}" onclick="launchServer('${r.origin}')">
                            <i class="fa-solid fa-rocket"></i> Launch
                        </button>
                    </div>
                `;
                listEl.appendChild(card);
            });

            countActiveEl.textContent = activeCount;
        }

        // --- TESTING ENGINE ---

        function cleanupOne(i) {
            if (timers[i]) {
                clearTimeout(timers[i]);
                timers[i] = null;
            }
            if (frames[i]) {
                frames[i].remove();
                frames[i] = null;
            }
        }

        function finalizeIfDone() {
            const allDone = results.every(r => r.status !== 'testing');
            if (allDone && !firstActiveOrigin) {
                spinnerEl.classList.add('hidden');
                noServersMsg.classList.remove('hidden');
                statusText.textContent = "No servers found";
                // Force manual mode to show user the blocked list
                if (!manualMode) {
                    manualMode = true; 
                    applyManualMode();
                }
            }
        }

        function startTests() {
            const timeoutMs = 2500;
            mirrors.forEach((host, i) => {
                const f = document.createElement('iframe');
                f.style.display = 'none';
                document.body.appendChild(f);
                frames[i] = f;
                
                timers[i] = setTimeout(() => {
                    if (results[i].status === 'testing') {
                        results[i].status = 'blocked';
                        renderList();
                        cleanupOne(i);
                        finalizeIfDone();
                    }
                }, timeoutMs);

                try {
                    const u = new URL(host);
                    u.hash = "injex=" + tokens[i];
                    f.src = u.toString();
                } catch (e) {
                    console.error("Invalid URL", host);
                }
            });
        }

        window.addEventListener("message", function (e) {
            const d = e.data || {};
            if (d.type !== "injex:ready") return;
            if (d.title !== expectedTitle) return;
            
            const idx = tokens.indexOf(d.token);
            if (idx < 0) return;
            
            cleanupOne(idx);
            
            const origin = new URL(mirrors[idx]).origin + "/";
            results[idx].status = "unblocked";
            results[idx].origin = origin;
            
            if (!firstActiveOrigin) {
                firstActiveOrigin = origin;
                statusText.textContent = "Ready";
                // Update Auto Launch UI
                autoLaunchBtn.onclick = () => launchServer(firstActiveOrigin);
                
                if (!manualMode) {
                    applyManualMode(); // Shows auto launch
                }
            }
            
            renderList();
            finalizeIfDone();
        });

        // --- PREVIEW & LAUNCH LOGIC (CLOAKING) ---

        // 1. Preview Logic: Shows iframe overlay
        window.previewServer = function(url) {
            previewFrame.src = url;
            previewOverlay.style.display = 'flex';
        };

        closePreviewBtn.addEventListener('click', () => {
            previewOverlay.style.display = 'none';
            previewFrame.src = 'about:blank';
        });

        // 2. Launch Logic: Redirects to about:blank then sends this page to dashboard
        window.launchServer = function(url) {
            // Open about:blank in new tab
            const win = window.open('about:blank', '_blank');
            
            if (win) {
                // Cloak the URL inside about:blank
                const html = `
                    <!DOCTYPE html>
                    <html style="margin:0;height:100%;overflow:hidden;">
                    <head><title>Dashboard</title></head>
                    <body style="margin:0;height:100%;overflow:hidden;">
                        <iframe src="${url}" style="border:0;width:100%;height:100%;" allowfullscreen></iframe>
                    </body>
                    </html>
                `;
                win.document.write(html);
                win.document.close();
                
                // Redirect THIS page to dashboard as requested
                window.location.href = 'dashboard.html';
            } else {
                alert('Popup blocked! Please allow popups to launch the server.');
            }
        };

        // Start
        init();

    </script>
</body>
</html>
