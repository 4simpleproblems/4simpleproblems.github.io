<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - DAILYPHOTO</title>
    <meta name="description" content="Share your day with friends through three daily photos.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>

    <script src="../injector.js"></script>
    <style>
        /* BUBBLY ANIMATIONS */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }

        /* --- BASE STYLES --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #040404; 
            color: #c0c0c0; 
            font-weight: 300; 
            overflow: hidden; /* Prevent body scroll */
            height: 100vh;
        }
        
        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important; 
        }

        /* --- THEME BUTTONS --- */
        .btn-toolbar-style {
            background: #000000;
            border: 1px solid #333;
            border-radius: 0.75rem;
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            border-color: #fff;
            color: #ffffff;
        }
        
        /* Specific override for active state to ensure no conflict */
        .btn-toolbar-style.active, .btn-primary-override {
            background-color: rgba(79, 70, 229, 0.1) !important;
            border: 1px solid #4f46e5 !important;
            color: #4f46e5 !important;
        }
        .btn-toolbar-style.active:hover, .btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15) !important;
            border-color: #6366f1 !important;
            color: #6366f1 !important;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem; 
            height: 2.5rem; 
            border-radius: 0.5rem;
            background-color: #000000;
            border: 1px solid #333;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            border-color: #fff;
            color: #fff;
        }
        
        /* --- LAYOUT --- */
        .messenger-container {
            display: block; 
            width: 100vw;
            height: calc(100vh - 4rem); 
            margin-top: 4rem; 
        }

        /* --- SIDEBAR (Fixed Left) --- */
        .left-panel {
            position: fixed;
            top: 4rem;
            left: 0;
            bottom: 0;
            width: 350px;
            background-color: #000000;
            border-right: 1px solid #1a1a1a;
            display: flex;
            flex-direction: column;
            z-index: 50;
        }

        .left-panel-scroll-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
            mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
        }
        .left-panel-scroll-content::-webkit-scrollbar { width: 6px; }
        .left-panel-scroll-content::-webkit-scrollbar-thumb { background-color: #333; border-radius: 3px; }
        .left-panel-scroll-content::-webkit-scrollbar-track { background-color: #000; }

        .sidebar-bottom-controls {
            display: flex;
            width: 100%;
            border-top: 1px solid #1a1a1a;
            background-color: #000000;
            padding: 0; 
        }
        .sidebar-control-btn {
            flex: 1; 
            color: #6b7280;
            font-size: 1.25rem;
            padding: 1rem 0;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0; 
        }
        .sidebar-control-btn:hover { color: #d1d5db; }
        .sidebar-control-btn.active { color: #4f46e5; background-color: transparent; }

        /* --- LISTS --- */
        .compact-list-wrapper {
             background-color: #000000;
             border-radius: 0.75rem; 
             border: 1px solid #1a1a1a; 
             margin-top: 0.75rem;
        }
        .compact-list-items {
            overflow-y: auto;
            max-height: 250px; 
            padding: 0.25rem; 
        }
        .compact-list-items::-webkit-scrollbar { width: 4px; }
        .compact-list-items::-webkit-scrollbar-thumb { background-color: #4f46e5; }
        
        .compact-list-item {
            border-radius: 0.5rem; 
            margin-bottom: 2px;
            padding: 0.5rem; 
            transition: background-color 0.2s;
        }
        .compact-list-item:hover { background-color: #111; }

        /* --- FEED PANEL --- */
        .feed-panel { 
            margin-left: 350px; 
            height: 100%;
            background-color: #040404;
            padding: 0.75rem 1.5rem 1.5rem 1.5rem; 
            overflow-y: auto; 
        }
        
        .feed-content-inner {
            max-width: 1000px; 
            margin: 0 auto; 
            padding-bottom: 5rem; 
        }
        
        .feed-toggle {
            display: flex;
            gap: 0.5rem;
            background: transparent;
            padding: 0;
        }

        /* --- GRID & PHOTOS --- */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 1rem; 
        }
        .photo-thumbnail {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            cursor: pointer;
            aspect-ratio: 1 / 1; 
            background-color: #0a0a0a;
            border: 1px solid #1a1a1a;
        }
        .photo-thumbnail img {
            width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;
        }
        .photo-thumbnail:hover img { transform: scale(1.05); }
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            pointer-events: none; 
        }
        .title-overlay {
            position: absolute; bottom: 0.5rem; left: 0.5rem; right: 0.5rem;
            color: white; font-size: 0.85rem; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            z-index: 10;
        }
        
        .photo-thumbnail .flex span { border-radius: 0.5rem; }
        
        /* --- MODAL STYLES --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 200; 
            transition: opacity 0.3s ease;
        }
        
        .modal-content {
            background-color: #0d0d0d; 
            border: 1px solid #1a1a1a;
            border-radius: 1rem;
            padding: 0; 
            max-width: 90%; width: 1200px;
            max-height: 90vh; 
            aspect-ratio: 16 / 9; 
            display: flex; overflow: hidden;
            position: relative;
        }
        
        @media (max-height: 800px) {
            .modal-content {
                max-height: 75vh; 
                max-width: 80%;
            }
        }
        
        #photo-display-area {
            flex: 2;
            background-color: #000;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .photo-modal-img {
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: all 0.2s ease-in-out; 
        }

        #photo-info-panel {
            flex: 1;
            min-width: 350px;
            max-width: 400px;
            background-color: #0d0d0d;
            border-left: 1px solid #1a1a1a;
            display: flex; flex-direction: column;
            padding: 1.5rem;
            position: relative;
        }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 0.5rem; gap: 1rem;
        }
        .modal-title-box { flex-grow: 1; overflow: hidden; }
        
        .modal-actions-box { 
            display: flex; gap: 0.5rem; flex-shrink: 0; align-items: center;
        }

        #comments-section {
            flex-grow: 1;
            background-color: #000000; 
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            overflow-y: auto;
            border: 1px solid #1a1a1a;
            mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
        }
        
        .comment-input-area {
            display: flex; gap: 0.5rem; align-items: center;
            position: relative; /* Added for emoji menu */
        }

        /* Helpers */
        .hidden { display: none !important; }
        .opacity-0 { opacity: 0; }
        .opacity-100 { opacity: 1; }
        
        input.thin-font { font-weight: 300 !important; }

        /* Custom Tooltip */
        #custom-tooltip {
            position: fixed; background-color: #000; border: 1px solid #333; color: #fff;
            padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-size: 0.75rem;
            pointer-events: none; z-index: 10000; opacity: 0; transition: opacity 0.15s ease;
            white-space: nowrap; box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="pt-16">

    <div id="custom-tooltip"></div>

    <div id="disclaimer-modal" class="fixed inset-0 bg-black/80 z-50 flex items-end justify-center opacity-0 transition-opacity duration-500 ease-in-out hidden">
        <div class="w-full max-w-7xl mx-auto px-4">
            <div id="disclaimer-banner" class="bg-gray-900/50 backdrop-blur-md rounded-t-xl border-t border-gray-800 shadow-2xl p-6 md:flex md:items-center md:justify-between space-y-4 md:space-y-0" role="alert">
                <div class="max-w-4xl">
                    <h3 class="text-xl font-normal text-white mb-2">Internet Safety & Public Feed</h3>
                    <p class="text-sm text-gray-400 font-light mb-3">
                        By continuing to the Public Feed, you may encounter media that does not comply with school rules.
                        For your safety and the safety of others, you must agree to report any post that violates our policies as soon as possible.
                        Please be aware that **falsely reporting a post may result in a temporary ban**.
                    </p>
                    <a href="https://www.justice.gov/criminal/criminal-ceos/keeping-children-safe-online" target="_blank" class="text-blue-400 hover:text-blue-300 underline transition text-sm">
                        Learn more about keeping children safe online
                    </a>
                </div>
                <div class="flex-shrink-0 flex gap-3">
                    <button id="disclaimer-cancel-btn" class="w-full md:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-normal rounded-xl text-white bg-white/10 ring-1 ring-white/20 hover:bg-white/20 transition duration-150 transform hover:scale-[1.02]">
                        Go back to Friends Feed
                    </button>
                    <button id="disclaimer-confirm-btn" class="w-full md:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-normal rounded-xl text-white bg-purple-500/10 ring-1 ring-purple-500/50 hover:bg-purple-500/20 transition duration-150 transform hover:scale-[1.02]">
                        Continue to Public Feed
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="photo-modal" class="modal-backdrop hidden">
        <div id="modal-content-container" class="modal-content"></div>
    </div>
    
    <div id="upload-menu-modal" class="modal-backdrop hidden opacity-0">
        <div class="bg-[#0d0d0d] border border-[#1a1a1a] rounded-xl w-full max-w-sm p-6">
            <h3 id="upload-menu-title" class="text-xl mb-4 text-white">Post Photo</h3>
            <input type="file" id="upload-file-input" class="hidden" accept="image/*" data-slot-index="">
            <div id="upload-select-options" class="flex flex-col gap-3 mb-6">
                 <label for="upload-file-input" id="upload-drop-area" class="bg-black border-2 border-dashed border-[#333] rounded-lg p-8 text-center cursor-pointer hover:border-indigo-500 transition-colors">
                    <i class="fas fa-cloud-upload-alt text-4xl mb-3 text-gray-500"></i>
                    <span class="block font-semibold text-gray-400">Select Image</span>
                 </label>
            </div>
            <button id="upload-menu-close-btn" class="btn-toolbar-style mt-4 w-full">Cancel</button>
        </div>
    </div>

    <main id="messenger-ui" class="messenger-container" style="display: none;">
        
        <aside class="left-panel">
            <div class="left-panel-scroll-content">
                
                <div class="mb-6 pb-4 border-b border-[#1a1a1a]">
                    <h2 class="text-lg text-white mb-2">My Code</h2>
                    <div id="friend-code-display" class="p-2 text-center bg-black border border-[#333] rounded-md font-mono text-indigo-400 tracking-widest select-all cursor-pointer" data-tooltip="Click to Copy">LOADING</div>
                </div>

                <div class="mb-6 pb-4 border-b border-[#1a1a1a]">
                    <h2 class="text-lg text-white mb-2">Add Friend</h2>
                    <form id="add-friend-form" class="flex gap-2">
                        <input type="text" id="friend-code-input" placeholder="CODE" maxlength="8" class="flex-grow p-2 bg-black border border-[#333] rounded-md outline-none focus:border-indigo-500 text-center font-mono uppercase text-white thin-font">
                        <button type="submit" class="btn-icon" data-tooltip="Send Request"><i class="fas fa-plus"></i></button>
                    </form>
                    <div id="add-friend-message" class="text-xs mt-2 min-h-[16px]"></div>
                </div>

                <div id="daily-posts-section">
                    <h2 class="text-lg text-white mb-2">My Posts</h2>
                    <p class="text-xs text-gray-500 mb-2">5 slots / day</p>
                    <div id="daily-posts-wrapper" class="compact-list-wrapper">
                        <div id="daily-posts-container" class="compact-list-items"></div>
                    </div>
                </div>

                <div id="friends-section-wrapper" class="hidden">
                    <h2 class="text-lg text-white mb-2">Friends</h2>
                    <div id="friends-list-wrapper" class="compact-list-wrapper">
                        <div id="friends-list-items" class="compact-list-items"></div>
                    </div>
                </div>

                <div id="blocked-section" class="hidden">
                    <h2 class="text-lg text-white mb-2">Blocked</h2>
                    <div id="blocked-list-wrapper" class="compact-list-wrapper">
                        <div id="blocked-list-items" class="compact-list-items"></div>
                    </div>
                </div>

            </div>

            <div class="sidebar-bottom-controls">
                <button id="sidebar-nav-posts" class="sidebar-control-btn active" title="My Posts"><i class="fas fa-images"></i></button>
                <button id="sidebar-nav-friends" class="sidebar-control-btn" title="Friends"><i class="fas fa-user-friends"></i></button>
                <button id="sidebar-nav-blocked" class="sidebar-control-btn" title="Blocked Users"><i class="fas fa-user-shield"></i></button>
            </div>
        </aside>

        <section class="feed-panel">
            <div class="feed-content-inner">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl text-white">Today's Feed</h1>
                    
                    <div class="feed-toggle">
                        <button id="feed-toggle-friends" class="btn-toolbar-style btn-primary-override active">
                            <i class="fas fa-user-friends"></i> Friends
                        </button>
                        <button id="feed-toggle-public" class="btn-toolbar-style">
                            <i class="fas fa-globe"></i> Public
                        </button>
                    </div>
                </div>
                
                <div id="photo-feed" class="photo-grid"></div>
            </div>
        </section>

    </main>

    <div id="loading-screen" class="fixed inset-0 bg-black flex justify-center items-center z-[100]">
        <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-600"></i>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, collection, query, where, getDocs, serverTimestamp, orderBy, deleteDoc, onSnapshot, writeBatch, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { firebaseConfig } from "../firebase-config.js";
        
        if (!firebaseConfig || !firebaseConfig.apiKey) throw new Error("Missing Firebase Config.");
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let CURRENT_FRIENDS = [];
        let CURRENT_USERNAME = 'User'; 
        let UNSUBSCRIBE_POSTS = () => {};
        let UNSUBSCRIBE_MODAL = () => {}; 
        let BLOCKED_USERS = []; 
        let CURRENT_FEED_MODE = 'friends';
        let PENDING_FILE = null;
        let PENDING_SLOT = 0;
        let PHOTO_DISPLAY_MODE = 0; 
        let ALL_FRIEND_PROFILES = [];
        
        const DAILY_COLLECTION = collection(db, 'daily_photos');
        const USERS_COLLECTION = 'users';

        // EMOJI CONSTANT (Moved up for reuse in modal and post creation)
        const EMOJIS = ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ¥²","ðŸ¥¹","â˜ºï¸","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Œ","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","ðŸ˜‹","ðŸ˜›","ðŸ˜","ðŸ˜œ","ðŸ¤ª","ðŸ¤¨","ðŸ§","ðŸ¤“","ðŸ˜Ž","ðŸ¥¸","ðŸ¤©","ðŸ¥³","ðŸ˜","ðŸ˜’","ðŸ˜ž","ðŸ˜”","ðŸ˜Ÿ","ðŸ˜•","ðŸ™","â˜¹ï¸","ðŸ˜£","ðŸ˜–","ðŸ˜«","ðŸ˜©","ðŸ¥º","ðŸ˜¢","ðŸ˜­","ðŸ˜¤","ðŸ˜ ","ðŸ˜¡","ðŸ¤¬","ðŸ¤¯","ðŸ˜³","ðŸ¥µ","ðŸ¥¶","ðŸ˜±","ðŸ˜¨","ðŸ˜°","ðŸ˜¥","ðŸ˜“","ðŸ¤—","ðŸ¤”","ðŸ¤­","ðŸ¤«","ðŸ¤¥","ðŸ˜¶","ðŸ˜","ðŸ˜‘","ðŸ˜¬","ðŸ™„","ðŸ˜¯","ðŸ˜¦","ðŸ˜§","ðŸ˜®","ðŸ˜²","ðŸ¥±","ðŸ˜´","ðŸ¤¤","ðŸ˜ª","ðŸ˜µ","ðŸ˜µâ€ðŸ’«","ðŸ¤","ðŸ¥´","ðŸ¤¢","ðŸ¤®","ðŸ¤§","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤‘","ðŸ¤ ","ðŸ˜ˆ","ðŸ‘¿","ðŸ‘¹","ðŸ‘º","ðŸ¤¡","ðŸ’©","ðŸ‘»","ðŸ’€","â˜ ï¸","ðŸ‘½","ðŸ‘¾","ðŸ¤–","ðŸŽƒ","ðŸ˜º","ðŸ˜¸","ðŸ˜¹","ðŸ˜»","ðŸ˜¼","ðŸ˜½","ðŸ™€","ðŸ˜¿","ðŸ˜¾","ðŸ‘‹","ðŸ¤š","ðŸ–","âœ‹","ðŸ––","ðŸ‘Œ","ðŸ¤Œ","ðŸ¤","âœŒï¸","ðŸ¤ž","ðŸ¤Ÿ","ðŸ¤˜","ðŸ¤™","ðŸ‘ˆ","ðŸ‘‰","ðŸ‘†","ðŸ–•","ðŸ‘‡","â˜ï¸","ðŸ‘","ðŸ‘Ž","âœŠ","ðŸ‘Š","ðŸ¤›","ðŸ¤œ","ðŸ‘","ðŸ™Œ","ðŸ‘","ðŸ¤²","ðŸ¤","ðŸ™","âœï¸","ðŸ’…","ðŸ¤³","ðŸ’ª","ðŸ¦¾","ðŸ¦¿","ðŸ¦µ","ðŸ¦¶","ðŸ‘‚","ðŸ¦»","ðŸ‘ƒ","ðŸ§ ","ðŸ«€","ðŸ«","ðŸ¦·","ðŸ¦´","ðŸ‘€","ðŸ‘","ðŸ‘…","ðŸ‘„","ðŸ’‹","ðŸ©¸","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ–¤","ðŸ¤","ðŸ¤Ž","ðŸ’”","â£ï¸","ðŸ’•","ðŸ’ž","ðŸ’“","ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’","ðŸ’Ÿ","â˜®ï¸","âœï¸","â˜ªï¸","ðŸ•‰","â˜¸ï¸","âœ¡ï¸","ðŸ”¯","ðŸ•Ž","â˜¯ï¸","â˜¦ï¸","ðŸ›","â›Ž","â™ˆï¸","â™‰ï¸","â™Šï¸","â™‹ï¸","â™Œï¸","â™ï¸","â™Žï¸","â™ï¸","â™ï¸","â™‘ï¸","â™’ï¸","â™“ï¸","ðŸ†”","âš›ï¸"];
        
        // --- INTELLIGENT TOOLTIPS ---
        const tooltipEl = document.getElementById('custom-tooltip');
        
        document.body.addEventListener('mouseover', (e) => {
            const target = e.target.closest('[title]'); 
            if (!target) { tooltipEl.style.opacity = 0; return; }
            
            // If it's the tooltip itself, ignore
            if (target.id === 'custom-tooltip') return;

            const text = target.getAttribute('title');
            if (!text) return;
            
            target.dataset.originalTitle = text;
            target.removeAttribute('title');
            
            tooltipEl.textContent = text;
            tooltipEl.style.opacity = 1;
            
            const rect = target.getBoundingClientRect();
            const tipRect = tooltipEl.getBoundingClientRect();
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            const gap = 10;

            let top, left;

            if (rect.bottom + tipRect.height + gap <= winH) {
                top = rect.bottom + gap;
                left = rect.left + (rect.width/2) - (tipRect.width/2);
            } else if (rect.top - tipRect.height - gap >= 0) {
                top = rect.top - tipRect.height - gap;
                left = rect.left + (rect.width/2) - (tipRect.width/2);
            } else {
                top = rect.top + (rect.height/2) - (tipRect.height/2);
                if (rect.left > winW / 2) {
                    left = rect.left - tipRect.width - gap; 
                } else {
                    left = rect.right + gap; 
                }
            }
            
            if (left < gap) left = gap;
            if (left + tipRect.width > winW - gap) left = winW - tipRect.width - gap;

            tooltipEl.style.top = `${top}px`;
            tooltipEl.style.left = `${left}px`;
        });
        
        document.body.addEventListener('mouseout', (e) => {
            const target = e.target.closest('[data-original-title]');
            if(target) {
                target.setAttribute('title', target.dataset.originalTitle);
                tooltipEl.style.opacity = 0;
            }
        });
        
        // --- UTILS ---
        function formatCount(count) {
            if (count >= 1000) return (count / 1000).toFixed(1) + 'k';
            return count.toString();
        }
        
        async function cleanText(text) {
             // Simple sanitization for display
             text = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
             
             // Check against profanity list (placeholder logic)
             // In a real app, this would involve a robust server-side check.
             const isProfane = false; // Assume clean for now.
             
             return isProfane ? 'This content violates policy.' : text;
        }

        // --- FIREBASE REFS ---
        const getUserProfileDocRef = (uid) => doc(db, USERS_COLLECTION, uid);
        const getFriendCodeDocRef = (code) => doc(db, 'friend_codes', code.toUpperCase());
        const getPhotoDocRef = (id) => doc(DAILY_COLLECTION, id);

        // --- AUTH & USER PROFILE LOGIC ---

        async function generateUniqueFriendCode() {
            let code = '';
            let isUnique = false;
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            try {
                while (!isUnique) {
                    code = Array.from({ length: 8 }, () => characters.charAt(Math.floor(Math.random() * characters.length))).join('');
                    const codeDoc = await getDoc(getFriendCodeDocRef(code));
                    if (!codeDoc.exists()) isUnique = true;
                }
                return code;
            } catch (error) {
                console.error("Error generating friend code:", error);
                throw new Error("Failed to generate unique friend code.");
            }
        }

        async function handleFriendCodeLogic(user) {
            try {
                const userProfileRef = getUserProfileDocRef(user.uid);
                let userProfileSnap = await getDoc(userProfileRef);

                // Ensure profile exists with basic fields if it's new-ish or incomplete
                const profileData = userProfileSnap.exists() ? userProfileSnap.data() : {};
                CURRENT_USERNAME = profileData.username || 'User';

                if (!userProfileSnap.exists() || profileData.friends === undefined || profileData.dailySlotsUsed === undefined || profileData.lastPostReset === undefined || profileData.pending_requests === undefined) {
                    await setDoc(userProfileRef, {
                        username: profileData.username || 'User',
                        friends: profileData.friends || [],
                        dailySlotsUsed: profileData.dailySlotsUsed || [],
                        lastPostReset: profileData.lastPostReset || serverTimestamp(),
                        pending_requests: profileData.pending_requests || [],
                        blocked_users: profileData.blocked_users || [] // Ensure this is also present
                    }, { merge: true });
                    userProfileSnap = await getDoc(userProfileRef); // Re-fetch after creation
                }
                
                // Update global blocked list
                BLOCKED_USERS = userProfileSnap.data().blocked_users || [];

                const codeQuery = query(collection(db, 'friend_codes'), where('userId', '==', user.uid), limit(1));
                const codeQuerySnap = await getDocs(codeQuery);
                let existingCode = codeQuerySnap.empty ? null : codeQuerySnap.docs[0].id;
                
                if (!existingCode) {
                    document.getElementById('friend-code-display').textContent = 'GENERATING...';
                    const newCode = await generateUniqueFriendCode();
                    await setDoc(getFriendCodeDocRef(newCode), { userId: user.uid });
                    existingCode = newCode;
                }
                
                document.getElementById('friend-code-display').textContent = existingCode;
                
                // Copy to clipboard logic
                document.getElementById('friend-code-display').onclick = () => {
                    navigator.clipboard.writeText(existingCode).then(() => {
                        const originalText = document.getElementById('friend-code-display').textContent;
                        document.getElementById('friend-code-display').textContent = 'COPIED!';
                        setTimeout(() => {
                            document.getElementById('friend-code-display').textContent = originalText;
                        }, 1000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                };
                
                CURRENT_FRIENDS = userProfileSnap.data().friends || [];

            } catch (error) {
                console.error("Initialization error:", error);
                // Handle critical errors like not being able to fetch/set profile
            }
        }

        async function cleanupOldPosts(user) {
             const userRef = doc(db, USERS_COLLECTION, user.uid);
             const userData = (await getDoc(userRef)).data();
             const slots = userData.dailySlotsUsed || [];
             const lastReset = userData.lastPostReset?.toDate() || new Date(0);
             const now = new Date();

             // Check if it's a new day (e.g., reset at midnight UTC)
             const resetDate = new Date(lastReset);
             resetDate.setUTCHours(24, 0, 0, 0); // Next day's midnight UTC
             
             if (now >= resetDate) {
                // Time to reset slots
                const batch = writeBatch(db);
                const postsToDelete = slots.filter(id => id !== 'EMPTY' && id !== 'DELETED');

                for (const postId of postsToDelete) {
                    const postRef = doc(DAILY_COLLECTION, postId);
                    // Update the post status to 'expired' instead of deleting
                    batch.update(postRef, { status: 'expired' }); 
                }
                
                // Reset slots and update reset time
                batch.update(userRef, { 
                    dailySlotsUsed: [], 
                    lastPostReset: serverTimestamp() 
                }); 
                
                await batch.commit();
                
                // Re-fetch data for UI update
                return { needsReload: true };
             }
             
             return { needsReload: false };
        }


        // --- MAIN UI RENDERERS ---
        function renderDailyPosts(posts, dailySlotsUsed) {
            const slotsContainer = document.getElementById('daily-posts-container');
            slotsContainer.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const postId = dailySlotsUsed[i] || 'EMPTY';
                const div = document.createElement('div');
                div.className = "compact-list-item flex justify-between items-center";
                
                if (postId.length > 0 && postId !== 'EMPTY' && postId !== 'DELETED') {
                    const post = posts.find(p => p.id === postId);
                    if (post) {
                        const title = post.title || `Photo ${i+1}`;
                        div.innerHTML = `
                            <span class="text-gray-300 text-sm truncate max-w-[150px] cursor-pointer hover:text-indigo-400" onclick="openPhotoModal('${postId}')" title="${title}">${title}</span>
                            <div class="flex gap-1">
                                <button class="w-6 h-6 flex items-center justify-center text-indigo-400 rounded hover:text-indigo-600" onclick="window.openPhotoModal('${postId}')" title="View"><i class="fas fa-eye text-xs"></i></button>
                                <button class="w-6 h-6 flex items-center justify-center text-red-400 rounded hover:text-red-600" onclick="deletePost('${postId}')" title="Delete"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        `;
                    }
                } else if (postId === 'DELETED') {
                    div.innerHTML = `<span class="text-gray-500 text-sm italic">Slot ${i+1}: Used</span>`;
                } else {
                    div.innerHTML = `<span class="text-gray-500 text-sm italic">Slot ${i+1}: Empty</span>
                        <button class="w-6 h-6 flex items-center justify-center bg-indigo-900/50 text-indigo-400 rounded hover:bg-indigo-900" onclick="window.openUpload(${i})" title="Post Photo"><i class="fas fa-plus text-xs"></i></button>`;
                }
                slotsContainer.appendChild(div);
            }

            if (!document.getElementById('blocked-section').classList.contains('hidden')) {
                renderBlockedList();
            }
        }
        
        // Expose to global scope for use in inline HTML
        window.openUpload = (slotIndex) => {
            document.getElementById('upload-file-input').value = null; // Clear previous file
            document.getElementById('upload-file-input').dataset.slotIndex = slotIndex;
            PENDING_SLOT = slotIndex;
            document.getElementById('upload-menu-title').textContent = `Post Photo (Slot ${slotIndex + 1})`;
            document.getElementById('upload-menu-modal').classList.remove('hidden', 'opacity-0');
        };

        window.deletePost = async (postId) => {
             if(confirm('Are you sure you want to delete this post? This cannot be undone.')) {
                const currentUser = auth.currentUser;
                const userRef = doc(db, USERS_COLLECTION, currentUser.uid);
                const slots = (await getDoc(userRef)).data()?.dailySlotsUsed || [];
                const slotIndex = slots.indexOf(postId);
                
                const batch = writeBatch(db);
                // Delete document
                batch.delete(doc(DAILY_COLLECTION, postId));
                
                // Mark slot as DELETED
                if (slotIndex !== -1) {
                    slots[slotIndex] = 'DELETED';
                    batch.update(userRef, { dailySlotsUsed: slots });
                }
                
                // Remove the photo from all friends' hearts (optional but good practice)
                const friendsSnap = await getDocs(query(collection(db, USERS_COLLECTION), where('friends', 'array-contains', currentUser.uid)));
                friendsSnap.forEach(f => {
                    batch.update(f.ref, { 
                        'daily_posts': arrayRemove(postId) // Assuming you have a field in user profile for quick post IDs
                    }); 
                });

                await batch.commit();
            }
        }
        
        async function openPhotoModal(photoId) {
            const container = document.getElementById('modal-content-container');
            const modal = document.getElementById('photo-modal');
            const photoDocRef = doc(DAILY_COLLECTION, photoId);
            const currentUser = auth.currentUser;

            if (!currentUser) return;

            // Start loading state
            container.innerHTML = `<div id="photo-display-area"><i class="fas fa-circle-notch fa-spin text-4xl text-indigo-600"></i></div><div id="photo-info-panel"></div>`;
            modal.classList.remove('hidden');

            // Set up real-time listener for the photo document
            UNSUBSCRIBE_MODAL = onSnapshot(photoDocRef, (docSnap) => {
                if (!docSnap.exists()) {
                    container.innerHTML = `<div id="photo-display-area" class="text-white">Post Deleted</div><div id="photo-info-panel"></div>`;
                    UNSUBSCRIBE_MODAL();
                    return;
                }
                
                const data = docSnap.data();
                if (modal.classList.contains('hidden')) { modal.classList.add('hidden'); return; }

                const hearts = data.hearts || [];
                const comments = (data.comments || []).sort((a,b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));
                const isHearted = hearts.includes(currentUser.uid);
                const isOwner = data.creatorUid === currentUser.uid;

                // Render Modal Content
                container.innerHTML = `
                    <div id="photo-display-area">
                        <img src="${data.imageBase64}" class="photo-modal-img">
                    </div>
                    <div id="photo-info-panel">
                        <button id="close-modal-btn" class="absolute top-2 right-2 btn-icon" style="z-index: 50; border: none; background: transparent;" title="Close"><i class="fas fa-times text-xl text-gray-400 hover:text-white"></i></button>
                        <div class="modal-header mt-6">
                            <div class="modal-title-box">
                                <h2 class="text-xl text-white font-normal truncate" title="${data.title}">${data.title || 'Untitled'}</h2>
                                <p class="text-sm text-indigo-400 font-bold">${data.creatorUsername}</p>
                            </div>
                            <div class="modal-actions-box">
                                <button id="heart-btn" class="text-2xl transition-colors ${isHearted ? 'text-red-500' : 'text-gray-600 hover:text-red-500'}" title="${isHearted ? 'Unlike' : 'Like'}">
                                    <i class="fas fa-heart"></i> 
                                </button>
                                <span class="text-gray-400 text-sm font-mono">${formatCount(hearts.length)}</span>
                                <span class="text-gray-400 text-sm font-mono ml-4" title="Comments">
                                    <i class="fas fa-comment text-indigo-400 mr-1"></i> ${formatCount(comments.length)}
                                </span>
                                ${!isOwner ? `<button id="report-btn" class="text-red-500 hover:text-red-400 ml-2" title="Report Post"><i class="fas fa-flag"></i></button>` : ''}
                                ${isOwner ? `<button id="delete-btn" class="text-red-500 hover:text-red-400 ml-2" title="Delete Post"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                        </div>

                        <div id="comments-section" class="mt-4">
                            </div>

                        <form id="comment-form" class="comment-input-area flex-shrink-0">
                            <input type="text" id="comment-input" placeholder="Add a comment..." class="flex-grow p-2 bg-black border border-[#333] rounded-md outline-none focus:border-indigo-500 text-white thin-font" maxlength="150">
                            <button type="submit" class="btn-icon" style="width: 2.25rem; height: 2.25rem;" title="Send">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                `;
                
                // Render Comments
                const commentsSection = document.getElementById('comments-section');
                commentsSection.innerHTML = comments.map(c => `
                    <div class="mb-3 text-sm">
                        <span class="font-bold text-indigo-400 mr-2">${c.username}:</span>
                        <span class="text-gray-300">${c.text}</span>
                        ${c.uid === currentUser.uid ? `<button onclick="deleteComment('${photoId}', '${c.timestamp.seconds}', '${c.text.replace(/'/g, "\\'")}')" class="text-red-500 text-xs ml-2 hover:text-red-400" title="Delete Comment"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                `).join('');


                // --- Photo Zoom Logic (MODIFICATION 1: Removed limit by width mode) ---
                const photoArea = document.getElementById('photo-display-area');
                const photoImg = photoArea.querySelector('.photo-modal-img');
                
                PHOTO_DISPLAY_MODE = 0;
                photoArea.onclick = () => {
                    PHOTO_DISPLAY_MODE = (PHOTO_DISPLAY_MODE + 1) % 2; // CHANGE: %3 to %2
                    if (PHOTO_DISPLAY_MODE === 0) { // Default: Limited by both (cover)
                        photoImg.style.width = '100%';
                        photoImg.style.height = '100%';
                        photoImg.style.objectFit = 'cover';
                    } else if (PHOTO_DISPLAY_MODE === 1) { // Limit only by height (contain, fills height)
                        photoImg.style.width = 'auto';
                        photoImg.style.height = '100%';
                        photoImg.style.objectFit = 'contain';
                    }
                    // The "limit by width" mode is now gone, cycling between cover and contain (height limited).
                };

                // Events
                document.getElementById('close-modal-btn').onclick = () => {
                    modal.classList.add('hidden');
                    UNSUBSCRIBE_MODAL();
                    document.removeEventListener('click', closeMenuHandler);
                };
                
                document.getElementById('heart-btn').onclick = () => updateDoc(doc(DAILY_COLLECTION, photoId), { hearts: isHearted ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) });
                
                document.getElementById('comment-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const input = document.getElementById('comment-input');
                    const text = input.value.trim();
                    if(!text) return;
                    
                    await updateDoc(doc(DAILY_COLLECTION, photoId), {
                        comments: arrayUnion({
                            uid: currentUser.uid,
                            username: CURRENT_USERNAME,
                            text: await cleanText(text),
                            timestamp: new Date()
                        })
                    });
                    input.value = '';
                };

                if(isOwner) {
                    document.getElementById('delete-btn').onclick = async () => {
                        if(confirm('Are you sure you want to delete this post? This cannot be undone.')) {
                            const userRef = doc(db, USERS_COLLECTION, currentUser.uid);
                            const slots = (await getDoc(userRef)).data()?.dailySlotsUsed || [];
                            const slotIndex = slots.indexOf(photoId);
                            
                            const batch = writeBatch(db);
                            // Delete document
                            batch.delete(doc(DAILY_COLLECTION, photoId));
                            
                            // Mark slot as DELETED
                            if (slotIndex !== -1) {
                                slots[slotIndex] = 'DELETED';
                                batch.update(userRef, { dailySlotsUsed: slots });
                            }
                            
                            await batch.commit();
                            modal.classList.add('hidden');
                            UNSUBSCRIBE_MODAL();
                        }
                    };
                }
                
            });
        }
        
        window.deleteComment = async (photoId, timestampSeconds, text) => {
            const photoRef = doc(DAILY_COLLECTION, photoId);
            const photoSnap = await getDoc(photoRef);
            if (!photoSnap.exists()) return;
            
            const comments = photoSnap.data().comments || [];
            const currentUser = auth.currentUser;
            
            // Find the comment to delete based on the current user's UID, text, and timestamp
            const commentToDelete = comments.find(c => 
                c.uid === currentUser.uid &&
                c.text === text &&
                (c.timestamp?.seconds || 0) == timestampSeconds
            );
            
            if (commentToDelete) {
                await updateDoc(photoRef, {
                    comments: arrayRemove(commentToDelete)
                });
            }
        }
        
        // Expose to global scope
        window.openPhotoModal = openPhotoModal;

        // --- SIDEBAR NAV ---
        function switchSidebar(view) {
            // Hide all sections
            document.getElementById('daily-posts-section').classList.add('hidden');
            document.getElementById('friends-section-wrapper').classList.add('hidden');
            document.getElementById('blocked-section').classList.add('hidden');

            // Deactivate all nav buttons
            document.getElementById('sidebar-nav-posts').classList.remove('active');
            document.getElementById('sidebar-nav-friends').classList.remove('active');
            document.getElementById('sidebar-nav-blocked').classList.remove('active');

            // Show selected section
            if (view === 'posts') {
                document.getElementById('sidebar-nav-posts').classList.add('active');
                document.getElementById('daily-posts-section').classList.remove('hidden');
                // Posts are updated via onSnapshot in main init
            } else if (view === 'friends') {
                document.getElementById('sidebar-nav-friends').classList.add('active');
                document.getElementById('friends-section-wrapper').classList.remove('hidden');
                renderFriendsList();
            } else if (view === 'blocked') {
                document.getElementById('sidebar-nav-blocked').classList.add('active');
                document.getElementById('blocked-section').classList.remove('hidden');
                renderBlockedList();
            }
        }

        document.getElementById('sidebar-nav-posts').onclick = () => switchSidebar('posts');
        document.getElementById('sidebar-nav-friends').onclick = () => switchSidebar('friends');
        document.getElementById('sidebar-nav-blocked').onclick = () => switchSidebar('blocked');


        // Reusable Emoji Picker Logic (For Post Title and Comments)
        let closeMenuHandler = () => {}; // Updated to accept all unique IDs
        function setupEmojiPicker(triggerId, inputId, menuId, closeBtnId, listId, searchId) {
            const menu = document.getElementById(menuId);
            const list = document.getElementById(listId);
            const input = document.getElementById(inputId);
            const trigger = document.getElementById(triggerId);
            const search = document.getElementById(searchId);
            const closeBtn = document.getElementById(closeBtnId);

            if(!menu || !list || !input || !trigger || !search || !closeBtn) return;

            const renderEmojis = (filter = '') => {
                list.innerHTML = '';
                const lowerFilter = filter.toLowerCase().trim();
                EMOJIS.forEach(emoji => {
                    // Simple filter based on the character itself
                    if (lowerFilter && !emoji.includes(lowerFilter)) return; 
                    const btn = document.createElement('button');
                    btn.className = 'text-xl hover:bg-white/10 rounded p-1 transition flex justify-center items-center h-8 w-8';
                    btn.textContent = emoji;
                    btn.type = 'button'; // Prevent form submission
                    btn.onclick = () => {
                        input.value += emoji;
                        // For a text input, you might also want to set focus at the end
                        input.focus();
                        menu.classList.add('hidden');
                        document.removeEventListener('click', closeMenuHandler);
                    };
                    list.appendChild(btn);
                });
            };

            // Initial render
            renderEmojis();

            // Search input handler
            search.oninput = () => renderEmojis(search.value);

            // Trigger button handler
            trigger.onclick = (e) => {
                e.stopPropagation(); // Prevent the body click listener from immediately closing it
                menu.classList.toggle('hidden');
                if (!menu.classList.contains('hidden')) {
                    // Set up a global click handler to close the menu when clicking outside
                    closeMenuHandler = (event) => {
                        if (!menu.contains(event.target) && event.target !== trigger) {
                            menu.classList.add('hidden');
                            document.removeEventListener('click', closeMenuHandler);
                        }
                    };
                    document.addEventListener('click', closeMenuHandler);
                } else {
                    document.removeEventListener('click', closeMenuHandler);
                }
            };

            // Close button handler
            closeBtn.onclick = () => {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeMenuHandler);
            };
        }

        // --- UPLOAD PHOTO LOGIC ---
        document.getElementById('upload-file-input').onchange = (e) => {
            if (e.target.files.length === 0) return;
            
            const file = e.target.files[0];
            PENDING_FILE = file;
            
            // Show the file preview/confirm modal
            openPostConfirmModal(file, PENDING_SLOT);
        };
        
        document.getElementById('upload-menu-close-btn').onclick = () => {
            document.getElementById('upload-menu-modal').classList.add('hidden', 'opacity-0');
        };
        
        // Drag and drop logic for upload
        const dropArea = document.getElementById('upload-drop-area');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        dropArea.addEventListener('drop', handleDrop, false);

        function preventDefaults (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            dropArea.classList.add('border-indigo-500');
        }

        function unhighlight() {
            dropArea.classList.remove('border-indigo-500');
        }

        function handleDrop(e) {
            unhighlight();
            const dt = e.dataTransfer;
            const file = dt.files[0];
            
            if (file && file.type.startsWith('image/')) {
                 const slotIndex = document.getElementById('upload-file-input').dataset.slotIndex;
                 if (slotIndex) {
                    PENDING_SLOT = parseInt(slotIndex);
                    PENDING_FILE = file;
                    openPostConfirmModal(file, PENDING_SLOT);
                 } else {
                    alert("Error: Missing slot index for drop.");
                 }
            } else if (file) {
                 alert("File must be an image.");
            }
        }
        
        function openPostConfirmModal(file, slotIndex) {
            document.getElementById('upload-menu-modal').classList.add('hidden', 'opacity-0');
            const modal = document.getElementById('photo-modal');
            const container = document.getElementById('modal-content-container');
            
            modal.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = async (e) => {
                const imgData = e.target.result;
                const username = CURRENT_USERNAME; // Use current username

                container.innerHTML = `
                    <div id="photo-display-area" class="relative">
                        <img src="${imgData}" class="photo-modal-img" style="object-fit: contain;">
                        <span class="absolute top-2 left-2 text-white bg-black/50 p-1 rounded-md text-xs z-10">${file.name}</span>
                    </div>
                    <div id="photo-info-panel" class="p-4 flex flex-col">
                        <button id="close-modal-btn" class="absolute top-2 right-2 btn-icon" style="z-index: 50; border: none; background: transparent;" title="Close"><i class="fas fa-times text-xl text-gray-400 hover:text-white"></i></button>

                        <h2 class="text-xl text-white font-normal mb-2 mt-4">Confirm Post</h2>
                        <p class="text-sm text-gray-400 mb-6">Slot ${slotIndex + 1} will be used.</p>

                        <div class="mb-4 flex items-center gap-4">
                            <label class="text-xs text-gray-500">Post Publicly?</label>
                            <button id="public-toggle-btn" class="text-sm text-gray-400 flex items-center" data-public="false" title="Click to make this post visible in the Public Feed">
                                <i class="fas fa-toggle-off text-2xl text-red-500 mr-2"></i> Private (Friends Only)
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-xs text-gray-500 mb-1 block">Username</label>
                            <input type="text" id="create-username" class="w-full bg-black border border-[#333] rounded p-2 text-white outline-none" maxlength="20" value="${username}">
                        </div>

                        <div class="mb-4 relative">
                            <label class="text-xs text-gray-500 mb-1 block">Title</label>
                            <div class="relative">
                                <input type="text" id="create-description" class="w-full bg-black border border-[#333] rounded p-2 pr-10 text-white outline-none" maxlength="28" placeholder="Write a title...">
                                <button type="button" id="emoji-trigger-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-indigo-400" title="Add Emoji">
                                    <i class="fa-solid fa-face-kiss-wink-heart"></i>
                                </button>
                            </div>
                            <div id="emoji-picker-menu" class="hidden absolute right-0 top-full mt-2 w-64 bg-black border border-[#333] rounded-xl z-50 shadow-xl flex flex-col h-64">
                                <div class="flex justify-between items-center p-3 border-b border-[#333]">
                                    <input type="text" id="emoji-search" placeholder="Search..." class="bg-[#1a1a1a] border-none rounded text-xs p-1.5 text-white w-full mr-2 outline-none">
                                    <button id="close-emoji-menu" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                                </div>
                                <div id="emoji-list" class="flex-grow overflow-y-auto p-2 grid grid-cols-6 gap-1"> 
                                </div>
                            </div>
                        </div>

                        <div class="mb-4 flex-grow border border-[#1a1a1a] rounded p-3 bg-black/50 overflow-hidden relative min-h-[50px]">
                            <p class="text-xs text-gray-500">Image size: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                            <p class="text-xs text-red-400 mt-1">Image will be compressed and resized upon posting.</p>
                        </div>

                        <button id="confirm-post-btn" class="btn-toolbar-style btn-primary-override w-full mt-auto">
                            Post Daily Photo
                        </button>
                    </div>
                `;
                
                // Initialize emoji picker for the title input
                setupEmojiPicker('emoji-trigger-btn', 'create-description', 'emoji-picker-menu', 'close-emoji-menu', 'emoji-list', 'emoji-search');


                // Toggle public status
                document.getElementById('public-toggle-btn').onclick = (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('public-toggle-btn');
                    const isPublic = btn.dataset.public === 'true';
                    btn.dataset.public = (!isPublic).toString();
                    
                    const icon = btn.querySelector('i');
                    icon.classList.toggle('fa-toggle-off');
                    icon.classList.toggle('fa-toggle-on');
                    icon.classList.toggle('text-red-500');
                    icon.classList.toggle('text-green-500');
                    
                    btn.innerHTML = `<i class="${icon.className}"></i> ${!isPublic ? 'Public (Visible to All)' : 'Private (Friends Only)'}`;
                };

                // Post Button Logic
                document.getElementById('confirm-post-btn').onclick = async () => {
                    const btn = document.getElementById('confirm-post-btn');
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Posting...`;

                    const desc = document.getElementById('create-description').value.trim();
                    const usernameInput = document.getElementById('create-username').value;
                    const isPublic = document.getElementById('public-toggle-btn').dataset.public === 'true';
                    const newUsername = usernameInput.trim() || 'User';

                    if (!PENDING_FILE || !auth.currentUser) return;
                    
                    // Update username in profile if changed
                    if (newUsername !== CURRENT_USERNAME) {
                         CURRENT_USERNAME = newUsername;
                         updateDoc(doc(db, USERS_COLLECTION, auth.currentUser.uid), { username: newUsername });
                    }

                    const ref = doc(DAILY_COLLECTION);
                    await setDoc(ref, {
                        creatorUid: auth.currentUser.uid,
                        creatorUsername: await cleanText(newUsername),
                        createdAt: serverTimestamp(),
                        imageBase64: imgData, // Assuming base64 is handled here, or use a storage URL
                        title: await cleanText(desc) || "Daily Photo",
                        hearts: [],
                        comments: [],
                        isPublic: isPublic,
                        status: 'active'
                    });

                    const userRef = doc(db, USERS_COLLECTION, auth.currentUser.uid);
                    const userData = (await getDoc(userRef)).data();
                    const slots = userData.dailySlotsUsed || [];

                    if (PENDING_SLOT < slots.length) {
                        slots[PENDING_SLOT] = ref.id;
                    } else if (PENDING_SLOT === slots.length) {
                        slots.push(ref.id);
                    }

                    await updateDoc(userRef, {
                        dailySlotsUsed: slots
                    });
                    
                    modal.classList.add('hidden');
                    PENDING_FILE = null;
                    document.removeEventListener('click', closeMenuHandler); // Clean up emoji handler
                };

            }; 

            reader.readAsDataURL(file);
        }

        // --- FEED LOGIC ---
        async function renderFeed(snap) {
            const feed = document.getElementById('photo-feed');
            feed.innerHTML = '';
            
            // Collect post IDs and fetch necessary data (like comments count for the thumbnail)
            const postDataPromises = [];
            snap.forEach(d => {
                const data = d.data();
                if(BLOCKED_USERS.includes(data.creatorUid)) return;
                
                postDataPromises.push(new Promise(resolve => {
                    // For efficiency, usually comments/hearts counts would be aggregated server-side, 
                    // but here we resolve the promise immediately with the data from the snapshot.
                    resolve({
                        id: d.id,
                        data: data
                    });
                }));
            });
            
            const posts = await Promise.all(postDataPromises);
            
            posts.forEach(post => {
                const { id, data } = post;
                const thumbnailDiv = document.createElement('div');
                thumbnailDiv.className = "photo-thumbnail";
                thumbnailDiv.setAttribute('onclick', `openPhotoModal('${id}')`);
                
                // Truncate title for display
                const displayTitle = data.title.length > 25 ? data.title.substring(0, 25) + '...' : data.title;
                
                thumbnailDiv.innerHTML = `
                    <img src="${data.imageBase64}" alt="${data.title}">
                    <div class="overlay"></div>
                    <div class="title-overlay">
                        ${displayTitle}
                        <span class="text-xs text-gray-400 block">${data.creatorUsername}</span>
                    </div>
                `;
                
                feed.appendChild(thumbnailDiv);
            });
            
            if (posts.length === 0) {
                 feed.innerHTML = `<p class="text-center text-gray-500 col-span-full mt-8">${CURRENT_FEED_MODE === 'friends' ? 'Your friends haven\'t posted yet.' : 'The public feed is empty.'}</p>`;
            }
        }
        
        async function setupFeed(mode, user) {
            if (UNSUBSCRIBE_POSTS) UNSUBSCRIBE_POSTS();
            
            const now = new Date();
            // Start of today (UTC midnight, assuming daily reset happens at 24:00 UTC)
            const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            
            let q;
            
            if (mode === 'friends') {
                // Fetch friends profiles to get all UIDs (including self)
                const userProfileSnap = await getDoc(getUserProfileDocRef(user.uid));
                const userData = userProfileSnap.data() || {};
                
                CURRENT_FRIENDS = userData.friends || [];
                BLOCKED_USERS = userData.blocked_users || [];
                
                const friends_or_self = [user.uid, ...CURRENT_FRIENDS].filter(uid => !BLOCKED_USERS.includes(uid));
                
                // If no one to follow, just update daily posts and return empty feed
                if (friends_or_self.length === 0) {
                     const feed = document.getElementById('photo-feed');
                     feed.innerHTML = `<p class="text-center text-gray-500 col-span-full mt-8">Add friends to see their daily photos.</p>`;
                     onSnapshot(getUserProfileDocRef(user.uid), (docSnap) => {
                         const slots = docSnap.data().dailySlotsUsed || [];
                         renderDailyPosts([], slots);
                     });
                     UNSUBSCRIBE_POSTS = () => {}; // No feed subscription
                     return; 
                }

                q = query(
                    DAILY_COLLECTION, 
                    where('status', '==', 'active'),
                    where('creatorUid', 'in', friends_or_self), 
                    where('createdAt', '>=', today), 
                    orderBy('createdAt', 'desc') 
                );
                
                // Also set up listener for user's own posts for the sidebar
                onSnapshot(getUserProfileDocRef(user.uid), async (docSnap) => {
                     const slots = docSnap.data().dailySlotsUsed || [];
                     
                     // Fetch actual post data for the slots
                     const myPosts = await Promise.all(
                         slots
                             .filter(id => id !== 'EMPTY' && id !== 'DELETED')
                             .map(id => getDoc(getPhotoDocRef(id)))
                     );
                     
                     renderDailyPosts(myPosts.map(p => ({ id: p.id, ...p.data() })), slots);
                });

            } else if (mode === 'public') {
                q = query(
                    DAILY_COLLECTION, 
                    where('status', '==', 'active'),
                    where('isPublic', '==', true), 
                    where('createdAt', '>=', today), 
                    orderBy('createdAt', 'desc'), 
                    limit(100) 
                );
            } else {
                return setupFeed('friends', user);
            }

            UNSUBSCRIBE_POSTS = onSnapshot(q, renderFeed);
        }
        
        // --- FRIENDS LIST ---
        async function renderFriendsList() {
            const fList = document.getElementById('friends-list-items');
            fList.innerHTML = '';
            
            const searchContainer = document.getElementById('friends-section-wrapper');
            if (!document.getElementById('friend-search-input')) {
                const searchDiv = document.createElement('div');
                searchDiv.id = "friend-search-container";
                searchDiv.className = "mb-4";
                searchDiv.innerHTML = `
                    <input type="text" id="friend-search-input" placeholder="Search by Username..." class="w-full p-2 bg-black border border-[#333] rounded-md outline-none focus:border-indigo-500 text-white thin-font" oninput="filterFriends(this.value)">
                `;
                searchContainer.insertBefore(searchDiv, searchContainer.querySelector('.compact-list-wrapper'));
            }
            
            const friends = CURRENT_FRIENDS;
            const pending = (await getDoc(doc(db, USERS_COLLECTION, auth.currentUser.uid))).data()?.pending_requests || [];

            if (pending.length > 0) {
                const pTitle = document.createElement('div');
                pTitle.className = "p-2 text-xs font-bold text-indigo-400 uppercase tracking-widest border-b border-[#1a1a1a] mb-2";
                pTitle.textContent = "REQUESTS";
                fList.appendChild(pTitle);

                const pendingUserSnaps = await Promise.all(pending.map(uid => getDoc(getUserProfileDocRef(uid))));
                pendingUserSnaps.forEach(s => {
                    if (s.exists()) {
                         const name = s.data()?.username || `User ${s.id.substr(0,5)}...`;
                         const uid = s.id;
                         
                         const div = document.createElement('div');
                         div.className = "compact-list-item flex justify-between items-center";
                         div.innerHTML = `<span class="text-gray-400 text-sm truncate max-w-[150px]" title="${name}">${name}</span>
                            <div class="flex gap-1">
                                <button onclick="acceptFriend('${uid}')" class="text-green-400 text-xs border border-green-900 px-2 py-0.5 rounded" title="Accept"><i class="fas fa-check"></i></button>
                                <button onclick="rejectFriend('${uid}')" class="text-red-400 text-xs border border-red-900 px-2 py-0.5 rounded" title="Reject"><i class="fas fa-times"></i></button>
                            </div>
                         `;
                         fList.appendChild(div);
                    }
                });
            }
            
            // Friends List Title
            const fTitle = document.createElement('div');
            fTitle.id = "friends-list-title";
            fTitle.className = "p-2 text-xs font-bold text-indigo-400 uppercase tracking-widest border-b border-[#1a1a1a] mb-2";
            fTitle.textContent = `FRIENDS (${friends.length})`;
            fList.appendChild(fTitle);

            if (friends.length === 0) {
                fList.innerHTML += '<p class="text-gray-600 text-sm p-2">No friends yet. Add one above!</p>';
            }
            
            ALL_FRIEND_PROFILES = await Promise.all(friends.map(uid => getDoc(getUserProfileDocRef(uid))));

            ALL_FRIEND_PROFILES.forEach(s => {
                if (s.exists()) {
                     const name = s.data()?.username || `User ${s.id.substr(0,5)}...`;
                     const uid = s.id;
                     
                     const div = document.createElement('div');
                     div.className = "compact-list-item flex justify-between items-center";
                     div.dataset.username = name.toLowerCase();
                     div.innerHTML = `<span class="text-gray-400 text-sm truncate max-w-[150px]" title="${name}">${name}</span>
                        <div class="flex gap-1">
                            <button onclick="removeFriend('${uid}')" class="text-red-400 text-xs border border-red-900 px-2 py-0.5 rounded" title="Remove Friend"><i class="fas fa-user-times"></i></button>
                            <button onclick="blockUser('${uid}')" class="text-gray-400 text-xs border border-[#333] px-2 py-0.5 rounded" title="Block User"><i class="fas fa-user-slash"></i></button>
                        </div>
                     `;
                     fList.appendChild(div);
                }
            });
        }
        
        window.filterFriends = (query) => {
            const fList = document.getElementById('friends-list-items');
            const lowerQuery = query.toLowerCase().trim();
            let foundCount = 0;
            
            fList.querySelectorAll('.compact-list-item').forEach(item => {
                // Skip the REQUESTS section for filtering
                if (item.parentElement.id === 'friends-list-items' && item.previousElementSibling && item.previousElementSibling.textContent === 'REQUESTS') return;

                const name = item.dataset.username || '';
                if (name.includes(lowerQuery)) {
                    item.style.display = 'flex';
                    foundCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            const title = document.getElementById('friends-list-title');
            // Hide the Friends title if nothing matches the search, but only if there are no pending requests visible above it.
            if (title) title.style.display = foundCount > 0 || (document.querySelector('#friends-list-items > .p-2.text-xs.font-bold:not(#friends-list-title)')) ? 'block' : 'none';
        };

        // --- FRIEND REQUEST HANDLERS ---
        document.getElementById('add-friend-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('friend-code-input');
            const msgEl = document.getElementById('add-friend-message');
            const code = input.value.trim().toUpperCase();
            input.value = ''; // Clear input immediately
            msgEl.textContent = ''; // Clear previous message
            
            if (code.length !== 8) {
                msgEl.textContent = "Friend code must be 8 characters.";
                msgEl.className = "text-xs mt-2 min-h-[16px] text-red-500";
                return;
            }
            
            try {
                const codeDocSnap = await getDoc(getFriendCodeDocRef(code));
                if (!codeDocSnap.exists()) {
                    msgEl.textContent = "Invalid friend code.";
                    msgEl.className = "text-xs mt-2 min-h-[16px] text-red-500";
                    return;
                }
                
                const targetUid = codeDocSnap.data().userId;
                
                // 1. Check if target user profile exists/is valid
                const targetProfileSnap = await getDoc(getUserProfileDocRef(targetUid));
                if (!targetProfileSnap.exists()) {
                    msgEl.textContent = "Target user profile corrupted or missing.";
                    msgEl.className = "text-xs mt-2 min-h-[16px] text-red-500";
                    return;
                }
                
                if (targetUid === auth.currentUser.uid) {
                    msgEl.textContent = "You can't add yourself.";
                    msgEl.className = "text-xs mt-2 min-h-[16px] text-red-500";
                    return;
                }
                
                if (CURRENT_FRIENDS.includes(targetUid)) {
                    msgEl.textContent = "Already friends.";
                    msgEl.className = "text-xs mt-2 min-h-[16px] text-yellow-500";
                    return;
                }
                
                if (BLOCKED_USERS.includes(targetUid)) {
                    msgEl.textContent = "You have blocked this user.";
                    msgEl.className = "text-xs mt-2 min-h-[16px] text-red-500";
                    return;
                }

                const targetData = targetProfileSnap.data();
                const targetPendingRequests = targetData.pending_requests || [];
                
                if (targetPendingRequests.includes(auth.currentUser.uid)) {
                    msgEl.textContent = "Request already sent.";
                    msgEl.className = "text-xs mt-2 min-h-[16px] text-yellow-500";
                    return;
                }
                
                // Send request
                await updateDoc(getUserProfileDocRef(targetUid), {
                    pending_requests: arrayUnion(auth.currentUser.uid)
                });
                
                msgEl.textContent = "Friend request sent!";
                msgEl.className = "text-xs mt-2 min-h-[16px] text-green-500";

            } catch (error) {
                console.error("Error sending friend request:", error);
                msgEl.textContent = "Failed to send request. Try again.";
                msgEl.className = "text-xs mt-2 min-h-[16px] text-red-500";
            }
        };

        window.acceptFriend = async (targetUid) => {
            const myUid = auth.currentUser.uid;
            const batch = writeBatch(db);
            
            // 1. Remove from my pending requests
            batch.update(getUserProfileDocRef(myUid), { 
                pending_requests: arrayRemove(targetUid),
                friends: arrayUnion(targetUid) 
            });
            
            // 2. Add me to target's friends list
            batch.update(getUserProfileDocRef(targetUid), { 
                friends: arrayUnion(myUid) 
            });
            
            await batch.commit();
            
            // Force UI update
            await handleFriendCodeLogic(auth.currentUser); 
            renderFriendsList();
        };

        window.rejectFriend = async (targetUid) => {
            const myUid = auth.currentUser.uid;
            await updateDoc(getUserProfileDocRef(myUid), { 
                pending_requests: arrayRemove(targetUid)
            });
            // Force UI update
            await handleFriendCodeLogic(auth.currentUser); 
            renderFriendsList();
        };

        window.removeFriend = async (targetUid) => {
            if (!confirm("Are you sure you want to remove this user as a friend?")) return;
            const myUid = auth.currentUser.uid;
            const batch = writeBatch(db);

            // 1. Remove from my friends list
            batch.update(getUserProfileDocRef(myUid), { 
                friends: arrayRemove(targetUid) 
            });
            
            // 2. Remove me from target's friends list
            batch.update(getUserProfileDocRef(targetUid), { 
                friends: arrayRemove(myUid) 
            });
            
            await batch.commit();
            
            // Force UI update
            await handleFriendCodeLogic(auth.currentUser); 
            renderFriendsList();
        };
        
        // --- Blocked List Logic ---
        async function renderBlockedList() {
            const list = document.getElementById('blocked-list-items');
            list.innerHTML = '';
            
            if (BLOCKED_USERS.length === 0) {
                 list.innerHTML = '<p class="text-gray-600 text-sm p-2">No users blocked.</p>';
                 return; 
            }
            
            const blockedUserSnaps = await Promise.all(BLOCKED_USERS.map(uid => getDoc(doc(db, USERS_COLLECTION, uid))));
            
            blockedUserSnaps.forEach(s => {
                const name = s.data()?.username || `User ${s.id.substr(0,5)}...`;
                const uid = s.id;
                
                const div = document.createElement('div');
                div.className = "compact-list-item flex justify-between items-center";
                div.innerHTML = `<span class="text-gray-400 text-sm truncate max-w-[150px]" title="${name}">${name}</span> <button onclick="unblock('${uid}')" class="text-indigo-400 text-xs border border-indigo-900 px-2 py-0.5 rounded" title="Unblock User"><i class="fas fa-unlock-alt"></i></button>`;
                list.appendChild(div);
            });
        }
        
        window.unblock = async (uid) => {
             const myUid = auth.currentUser.uid;
             await updateDoc(doc(db, USERS_COLLECTION, myUid), { 
                blocked_users: arrayRemove(uid) 
             });
             BLOCKED_USERS = BLOCKED_USERS.filter(b => b !== uid);
             renderBlockedList();
             // If currently in friends list view, re-render to ensure blocked user is removed
             if (CURRENT_FEED_MODE === 'friends') setupFeed('friends', auth.currentUser); 
        }

        window.blockUser = async (uid) => {
            if (!confirm("Are you sure you want to block this user? This will also unfriend them.")) return;
            const myUid = auth.currentUser.uid;
            const batch = writeBatch(db);

            // 1. Add to my blocked list
            batch.update(doc(db, USERS_COLLECTION, myUid), { 
                blocked_users: arrayUnion(uid),
                friends: arrayRemove(uid) // Also unfriend
            });
            
            // 2. Remove me from target's friends list (if we were friends)
            batch.update(getUserProfileDocRef(uid), { 
                friends: arrayRemove(myUid) 
            });

            await batch.commit();

            // Force UI update
            await handleFriendCodeLogic(auth.currentUser); 
            
            // If currently in friends list view, re-render
            if (!document.getElementById('friends-section-wrapper').classList.contains('hidden')) renderFriendsList();
            
            // If currently viewing blocked, re-render
            if (!document.getElementById('blocked-section').classList.contains('hidden')) renderBlockedList();
            
            // If currently in friends feed, re-render to remove their posts
            if (CURRENT_FEED_MODE === 'friends') setupFeed('friends', auth.currentUser); 
        }
        
        
        // --- FEED TOGGLE HANDLERS (MODIFICATION 2: New Modal Logic) ---

        // Helper function to hide the modal with transition
        const hideDisclaimerModal = (callback) => {
            const modal = document.getElementById('disclaimer-modal');
            modal.classList.add('opacity-0');
            modal.classList.remove('opacity-100');
            // Wait for the CSS transition (500ms) to complete before setting display: none
            setTimeout(() => {
                modal.classList.add('hidden');
                if (callback) callback();
            }, 500); 
        }

        document.getElementById('feed-toggle-friends').onclick = () => {
            CURRENT_FEED_MODE = 'friends';
            setupFeed('friends', auth.currentUser);
        };
        
        document.getElementById('feed-toggle-public').onclick = () => {
            const modal = document.getElementById('disclaimer-modal');
            if(localStorage.getItem('public_agreed')) {
                CURRENT_FEED_MODE = 'public';
                setupFeed('public', auth.currentUser);
            } else {
                // SHOW: remove hidden, then remove opacity-0 after a tiny delay
                modal.classList.remove('hidden'); 
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.classList.add('opacity-100');
                }, 10);
            }
        };

        // Confirm button handler
        document.getElementById('disclaimer-confirm-btn').onclick = () => {
            hideDisclaimerModal(() => {
                localStorage.setItem('public_agreed', 'true');
                CURRENT_FEED_MODE = 'public';
                setupFeed('public', auth.currentUser);
            });
        };

        // Cancel button handler (Go back to Friends Feed)
        document.getElementById('disclaimer-cancel-btn').onclick = () => {
            hideDisclaimerModal();
        };

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                await signInAnonymously(auth);
                return;
            }
            try {
                await handleFriendCodeLogic(user);
                
                const { needsReload } = await cleanupOldPosts(user);
                
                if (needsReload) {
                    await handleFriendCodeLogic(user); // Re-run to get fresh profile data
                }
                
                setupFeed(CURRENT_FEED_MODE, user);
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('messenger-ui').style.display = 'block';

            } catch (e) {
                console.error("Initialization failed after sign in:", e);
                document.getElementById('loading-screen').innerHTML = `<div class="text-white">Error: Failed to load user data.</div>`;
            }
        });

    </script>
</body>
</html>
