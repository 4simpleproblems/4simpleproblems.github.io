<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - DAILYPHOTO</title>
    <meta name="description" content="Share your day with friends through three daily photos.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="./firebase-config.js"></script>

    <style>
        /* BUBBLY ANIMATIONS: Keyframes for cute/bubbly effects */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes particleGlow {
            0% { box-shadow: 0 0 5px #4f46e5, 0 0 10px #4f46e5; }
            50% { box-shadow: 0 0 10px #818cf8, 0 0 20px #818cf8; }
            100% { box-shadow: 0 0 5px #4f46e5, 0 0 10px #4f46e5; }
        }
        
        /* NOTE: Marquee animation removed per user request */

        /* --- FONT & BASE STYLING (MATCHING notes.html) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #040404; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
        }
        
        /* Ensure headings and strong text are slightly thicker but still thin */
        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important; 
        }

        /* --- THEME-AWARE STYLES (from notes.html, used for the new toggle) --- */
        
        .btn-toolbar-style {
            background: var(--menu-bg, #0000000);
            border: 1px solid var(--menu-border, #333);
            border-radius: 0.75rem;
            color: var(--menu-text, #d1d5db);
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        /* MODIFIED: Mode Toggle Hover now keeps black background, but text highlights */
        .btn-toolbar-style:hover {
            background-color: var(--menu-bg, #000000);
            border-color: var(--menu-border, #fff);
            color: var(--tab-hover-text, #ffffff);
        }
        
        /* The 'Active' state style for the toggle (Public mode) */
        .btn-toolbar-style.btn-primary-override {
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            border: 1px solid var(--tab-active-border, #4f46e5);
            color: var(--tab-active-text, #4f46e5);
        }
        /* Active Button Hover now uses Active Tab Hover Texture */
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
            border-color: var(--tab-active-hover-border, #6366f1);
            color: var(--tab-active-hover-text, #6366f1);
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem; /* 36px */
            height: 2.25rem; /* 36px */
            border-radius: 0.5rem;
            background-color: transparent;
            border: 1px solid transparent;
            color: var(--tab-text, #9ca3af);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            color: var(--tab-active-text, #4f46e5);
            border-color: var(--tab-active-border, #4f46e5);
        }
        .btn-icon.active {
             background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            color: var(--tab-active-text, #4f46e5);
            border-color: var(--tab-active-border, #4f46e5);
        }
        /* --- END: THEME-AWARE STYLES --- */


        /* Responsive Container */
        .messenger-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.5rem;
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* --- CONSISTENT PANEL STYLING (MATCHED to notes.html) --- */
        .left-panel, .feed-panel { 
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a; 
            border-radius: 1rem; 
            padding: 1.5rem; 
            height: fit-content;
        }
        
        /* General input styling to use thin font */
        input.p-2 {
            font-weight: 300 !important; 
        }

        /* --- Custom Friend Code Input Styling --- */
        .friend-code-input-styled {
            background-image: linear-gradient(to right, #1a1a1a 0%, #1a1a1a 90%);
            background-size: 12.5% 2px; 
            background-repeat: repeat-x;
            background-position: 0 90%;
            letter-spacing: 0.5rem !important; 
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
            border: none !important;
            box-shadow: none !important;
        }
        .friend-code-input-styled:focus {
             background-image: linear-gradient(to right, #4f46e5 0%, #4f46e5 90%);
        }
        
        /* --- Compact List Styling --- */
        .compact-list-wrapper {
             background-color: #0d0d0d;
             border-radius: 0.75rem; 
             padding: 0.25rem 0.5rem; 
             border: 1px solid #1a1a1a;
             margin-top: 0.75rem;
        }
        .compact-list-items {
            overflow-y: auto;
            max-height: 250px; 
            padding-right: 0.25rem; 
        }
        
        /* Custom scrollbar styles */
        .compact-list-items::-webkit-scrollbar { width: 8px; }
        .compact-list-items::-webkit-scrollbar-thumb { background-color: #4f46e5; border-radius: 4px; }
        .compact-list-items::-webkit-scrollbar-track { background-color: #1f2937; }

        /* General style for a list item/card */
        .compact-list-item {
            background-color: transparent; 
            border-radius: 0.5rem; 
            margin-bottom: 0.25rem;
            padding: 0.5rem 0.5rem; 
            transition: background-color 0.2s;
            border-bottom: none;
        }
        .compact-list-item:hover {
            background-color: #1f1f1f;
            transform: none; 
        }
        .compact-list-item:last-child {
             border-bottom: none;
        }
        
        .daily-post-card {
            border-bottom: none;
        }
        .daily-post-card:last-child {
             border-bottom: none;
        }
        
        #comments-section {
            overflow-y: auto;
            max-height: 50vh; 
            flex-grow: 1; 
        }
        
        .comment-text {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* --- FEED DISPLAY STYLING --- */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 1rem; 
        }
        .photo-thumbnail {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            cursor: pointer;
            aspect-ratio: 1 / 1; 
            background-color: #040404;
        }
        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); 
            pointer-events: none; 
        }
        
        .title-overlay {
            position: absolute;
            top: 0.5rem; 
            right: 0.5rem; 
            background-color: rgba(0, 0, 0, 0.75); 
            border-radius: 0.5rem; 
            padding: 0.25rem 0.5rem; 
            max-width: 70%; 
            color: white;
            font-size: 0.75rem; 
            font-weight: 600;
            background: rgba(0, 0, 0, 0.75);
            text-shadow: none; 
            height: 1.5rem; 
            display: flex;
            justify-content: flex-start;
            align-items: center; 
            overflow: hidden; 
            z-index: 10; 
        }

        .title-text-container {
            max-width: 100%; 
            overflow: hidden; 
            white-space: nowrap;
            /* Marquee logic removed: text will clip naturally */
        }
        
        .title-text-span {
            text-overflow: ellipsis; 
            display: block; 
        }
        
        #unread-comments-badge {
            animation: popIn 0.3s ease-out;
            height: 1.25rem; 
            width: 1.25rem; 
            font-size: 0.65rem;
            line-height: 1.25rem;
            text-align: center;
        }
        
        .modal-title-container {
             max-width: 100%;
             overflow: hidden; 
             white-space: nowrap;
             display: flex;
             font-weight: 700;
        }
        .modal-title-text {
            font-size: 1.5rem;
            line-height: 2rem;
            display: inline-block;
            white-space: nowrap;
            text-overflow: ellipsis; 
            overflow: hidden;
        }
        
        .photo-modal-img {
            width: 100%; 
            height: 100%; 
            max-width: 100%;
            object-fit: contain; 
            transition: all 0.3s ease;
        }
        
        /* Fullscreen Image Mode */
        .modal-content.fullscreen-image-mode {
             padding: 0;
             gap: 0;
        }
        .modal-content.fullscreen-image-mode #photo-view-main {
            flex-direction: row; 
            width: 100%;
            height: 100%;
            max-height: 90vh;
        }
        .modal-content.fullscreen-image-mode #photo-display-area {
            flex-grow: 10; 
        }
        .modal-content.fullscreen-image-mode #photo-info-panel {
            opacity: 0;
            pointer-events: none;
            width: 0;
            transition: opacity 0.3s ease-out, width 0.3s ease-out;
        }
        #photo-info-panel {
             transition: opacity 0.3s ease-in, width 0.3s ease-in;
        }
        /* --- END FEED STYLES --- */

        .upload-drop-zone {
            background-color: #0a0a0a;
            border: 2px dashed #1a1a1a; 
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            color: #505050;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        .upload-drop-zone:hover {
            border-color: #4f46e5;
            background-color: #0d0d0d; 
        }
        .upload-drop-zone.drag-over {
            border-color: #818cf8;
            background-color: #1a1a2e;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; /* Base modal z-index */
        }
        
        /* New Z-index for the Disclaimer to sit above other elements */
        #public-feed-disclaimer-modal {
            z-index: 10000;
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div id="loading-screen" class="fixed inset-0 bg-black flex items-center justify-center z-50">
        <div class="text-xl font-semibold">Loading Daily Photo...</div>
    </div>
    <div id="page-content" class="hidden">
        
        <header class="w-full max-w-[1400px] mx-auto p-4 flex justify-between items-center">
            <h1 class="text-3xl font-light text-gray-300 tracking-tighter">DailyPhoto</h1>
            <button id="visibility-toggle" class="btn-toolbar-style" title="Toggle Feed Visibility">
                <i id="visibility-toggle-icon" class="fas fa-user-friends"></i>
                <span id="visibility-toggle-text">Friends</span>
            </button>
        </header>

        <div class="messenger-container">
            <div class="left-panel flex flex-col gap-4">
                <h2 class="text-xl font-semibold text-white">Your Daily Posts</h2>
                <div id="daily-posts-container" class="compact-list-wrapper">
                    </div>
                <h2 class="text-xl font-semibold text-white mt-4">Friends List</h2>
                <div id="friends-list-items" class="compact-list-wrapper compact-list-items">
                    </div>
            </div>

            <div class="feed-panel">
                <h2 class="text-xl font-semibold text-white mb-4">The Feed</h2>
                <div id="photo-feed" class="photo-grid">
                    </div>
            </div>
        </div>
    </div>

    <div id="upload-photo-modal" class="modal-backdrop hidden opacity-0 transition-opacity duration-300">
        </div>
    
    <div id="photo-modal-container" class="modal-backdrop hidden opacity-0 transition-opacity duration-300">
        <div id="photo-modal-content" class="bg-[#0d0d0d] border border-[#1a1a1a] rounded-xl shadow-2xl p-6 w-[90%] max-w-5xl h-[90vh] flex flex-col transform scale-100 transition-transform duration-300" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
                <div class="modal-title-container">
                    <span id="modal-username" class="modal-title-text mr-2 font-bold text-white">Username</span>
                    <span id="modal-post-title" class="modal-title-text text-gray-400 font-light"> - Post Title</span>
                </div>
                <button id="close-photo-modal-btn" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div id="photo-view-main" class="flex-grow flex flex-col md:flex-row gap-4 max-h-[80vh]">
                <div id="photo-display-area" class="flex-grow flex items-center justify-center bg-black/50 rounded-lg overflow-hidden relative">
                    <img id="photo-modal-image" class="photo-modal-img" src="" alt="Post Image">
                    <div class="absolute top-2 right-2 flex gap-2">
                        <button id="toggle-fullscreen-btn" class="btn-icon bg-black/50 hover:bg-black/70 text-white" title="Toggle Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>

                <div id="photo-info-panel" class="w-full md:w-80 flex flex-col overflow-hidden">
                    <div class="flex-shrink-0 flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <div class="flex items-center gap-4">
                            <button id="heart-btn" data-post-id="" class="btn-icon text-red-400 hover:text-red-500" title="Love this post">
                                <i id="heart-icon" class="far fa-heart text-2xl"></i>
                                <span id="heart-count-modal" class="text-lg ml-1 font-semibold">0</span>
                            </button>
                            <span id="timestamp-modal" class="text-sm text-gray-500">2h ago</span>
                        </div>
                    </div>
                    
                    <div class="flex-shrink-0 flex justify-between items-center">
                        <div class="flex items-center gap-4 mt-2">
                            <button id="delete-post-trigger-btn" class="text-red-400 text-sm hover:text-red-500 hidden" title="Delete Post">
                                <i class="fas fa-trash-alt mr-1"></i> Delete Post
                            </button>
                            <button id="report-post-btn" data-post-id="" class="text-yellow-400 text-sm hover:text-yellow-500" title="Report Inappropriate Content">
                                <i class="fas fa-flag mr-1"></i> Report Post
                            </button>
                            <span id="report-status-badge" class="text-sm text-gray-500 ml-4 hidden"><i class="fas fa-exclamation-triangle mr-1"></i> Under Review</span>
                        </div>
                    </div>
                    
                    <div id="delete-confirmation-view" class="mt-2 p-2 bg-red-900/20 border border-red-700 rounded-md text-sm text-red-300 hidden">
                        <p>Are you sure you want to delete this post? This cannot be undone.</p>
                        <div class="flex justify-end gap-2 mt-2">
                            <button id="cancel-delete-btn" class="text-gray-400 hover:text-white">Cancel</button>
                            <button id="confirm-delete-btn" class="text-red-400 hover:text-red-300 font-bold">Delete</button>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold mt-4 mb-2 text-white">Comments</h3>
                    <div id="comments-section" class="flex-grow space-y-3 pr-2 overflow-y-auto">
                        </div>
                    
                    <div id="comment-input-area" class="flex-shrink-0 mt-4 border-t border-gray-700 pt-4">
                        <div class="flex gap-2">
                            <input type="text" id="comment-input" placeholder="Add a comment..." class="flex-grow bg-gray-800 border border-gray-700 rounded-lg p-2 text-sm text-gray-200 focus:ring-purple-500 focus:border-purple-500" maxlength="200">
                            <button id="send-comment-btn" class="px-4 py-2 bg-purple-500/10 text-purple-400 rounded-lg font-semibold ring-1 ring-purple-500/50 hover:bg-purple-500/20 transition">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="public-feed-disclaimer-modal" class="fixed inset-0 bg-black/95 z-[10000] flex items-end justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-gray-900 border border-gray-700 max-w-lg w-full p-6 mb-8 rounded-xl shadow-2xl transform scale-100 transition-transform duration-300" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-white">Mandatory Public Feed Warning</h3>
            <p class="text-gray-300 mb-6 font-light">
                <span class="font-semibold text-red-400">Disclaimer:</span> By proceeding to the "Public" feed, your posts will become visible to **all** users, including those outside your friend network, making them publicly accessible.
                <br><br>
                <span class="font-semibold text-yellow-400">Content Warning:</span> This public feed is not actively filtered and may contain graphic, offensive, or otherwise insensitive media. We rely on user reports to maintain community standards. Please use the <i class="fas fa-flag"></i> **Report Post** button on any content you find inappropriate.
            </p>
            <div class="flex-shrink-0">
                <button id="accept-public-feed-button" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-normal rounded-xl text-white bg-purple-500/10 ring-1 ring-purple-500/50 hover:bg-purple-500/20 transition duration-150 transform hover:scale-[1.02]">
                    I Understand and Accept the Risk
                </button>
            </div>
        </div>
    </div>
    
    <div id="toast-message" class="fixed bottom-4 right-4 bg-gray-900 border border-gray-700 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 z-[60]"></div>


    <script type="module">
        // Standard Firebase Initialization
        const { initializeApp } = firebase.app;
        const { getAuth, onAuthStateChanged } = firebase.auth;
        const { getFirestore, collection, doc, query, where, getDoc, getDocs, updateDoc, setDoc, arrayUnion, arrayRemove, serverTimestamp, onSnapshot, writeBatch, orderBy, limit, deleteDoc } = firebase.firestore;
        const { getStorage, ref, uploadString, getDownloadURL } = firebase.storage;
        
        // Ensure firebaseConfig is loaded from firebase-config.js
        if (!window.firebaseConfig) {
            document.getElementById('loading-screen').innerHTML = '<p class="text-red-400">ERROR: Missing or incomplete Firebase configuration in firebase-config.js. Check the console for details.</p>';
            console.error("Firebase Configuration Error: The 'firebase-config.js' file is likely missing or does not contain a valid configuration object.");
            throw new Error("Missing Firebase Config.");
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Global State & Constants ---
        let CURRENT_FRIENDS = [];
        let CURRENT_USERNAME = 'DailyUser';
        let UNSUBSCRIBE_POSTS_LISTENER = () => {}; // Used for the main feed
        let UNSUBSCRIBE_DAILY_SLOTS_LISTENER = () => {}; // Used for the user's post slots
        let MODAL_UNSUBSCRIBE_LISTENER = () => {};
        let LAST_COMMENT_TIMESTAMP = 0;
        let LAST_HEART_TIMESTAMP = 0;
        let UNREAD_COMMENTS_COUNT = 0;
        
        // NEW: Visibility Toggle State Variables
        let CURRENT_FEED_MODE = 'FRIENDS'; // State Variable Initialization
        let PUBLIC_MODE_ACCEPTED = false; // Tracks if the disclaimer has been accepted

        const DAILY_PHOTO_COLLECTION = collection(db, 'daily_photos');
        const USER_PROFILES_COLLECTION = collection(db, 'user_profiles');
        const FRIEND_CODES_COLLECTION = collection(db, 'friend_codes');
        const REPORTED_POSTS_COLLECTION = collection(db, 'reported_daily_photos'); // NEW: Collection for reported posts

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        const photoFeed = document.getElementById('photo-feed');
        const dailyPostsContainer = document.getElementById('daily-posts-container');
        const friendCodeDisplay = document.getElementById('friend-code-display'); // Assumed to exist in original dailyphoto.html
        const friendsListItems = document.getElementById('friends-list-items');
        const addFriendMessage = document.getElementById('add-friend-message'); // Assumed to exist in original dailyphoto.html
        const uploadMessage = document.getElementById('upload-message'); // Assumed to exist in original dailyphoto.html
        const photoModalContainer = document.getElementById('photo-modal-container');
        const photoModalImage = document.getElementById('photo-modal-image');
        const commentInput = document.getElementById('comment-input');
        
        // NEW: Toggle & Disclaimer Elements
        const toggleFeedBtn = document.getElementById('visibility-toggle');
        const toggleIcon = document.getElementById('visibility-toggle-icon');
        const toggleText = document.getElementById('visibility-toggle-text');
        const disclaimerModal = document.getElementById('public-feed-disclaimer-modal');
        const acceptDisclaimerBtn = document.getElementById('accept-public-feed-button');

        // MARQUEE DEPENDENCY REMOVAL: No MARQUEE_TRIGGER_LENGTH constant is included, and no marquee JS logic is present.
        
        // --- Utility Functions (Mocked/Assumed to Exist) ---
        
        /**
         * @brief Formats large numbers into abbreviated strings (K, M, B).
         */
        function formatCount(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            if (num < 1000) return String(num);
            const suffixes = ["", "K", "M", "B"];
            let tier = 0;
            let currentNum = num;
            while (currentNum >= 1000 && tier < suffixes.length - 1) {
                currentNum /= 1000;
                tier++;
            }
            return currentNum.toFixed(1).replace(/\.0$/, '') + suffixes[tier];
        }
        
        /**
         * @brief Shows a transient message (toast).
         */
        function showMessage(element, message, type = 'info') {
            const toastElement = document.getElementById('toast-message');
            toastElement.textContent = message;
            toastElement.className = 'fixed bottom-4 right-4 p-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-100 z-[60] text-white';
            
            if (type === 'success') toastElement.classList.add('bg-green-600', 'border-green-800');
            else if (type === 'error') toastElement.classList.add('bg-red-600', 'border-red-800');
            else toastElement.classList.add('bg-gray-900', 'border-gray-700');
            
            setTimeout(() => {
                toastElement.classList.remove('opacity-100');
                setTimeout(() => {
                    // Reset classes after fade-out
                    toastElement.className = 'fixed bottom-4 right-4 opacity-0 transition-opacity duration-300 z-[60]';
                }, 300); 
            }, 3000); 
        }

        /**
         * @brief Shows a persistent, blocking modal.
         */
        function showCustomModal(title, body, type = 'info') {
            const modalHtml = `
                <div id="temp-custom-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[10010]">
                    <div class="bg-gray-900 border border-gray-700 max-w-sm w-full p-6 rounded-xl shadow-2xl transform scale-100 transition-transform duration-300">
                        <h3 class="text-xl font-bold mb-4 ${type === 'error' ? 'text-red-400' : 'text-white'}">${title}</h3>
                        <p class="text-gray-300 mb-6 font-light">${body}</p>
                        <div class="flex justify-end">
                            <button onclick="document.getElementById('temp-custom-modal').remove()" class="px-4 py-2 bg-purple-500/10 text-purple-400 rounded-lg font-semibold ring-1 ring-purple-500/50 hover:bg-purple-500/20 transition">
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * @brief Closes the main photo modal.
         */
        function closePhotoModal() {
            photoModalContainer.classList.remove('opacity-100');
            photoModalContainer.classList.add('opacity-0');
            setTimeout(() => {
                photoModalContainer.classList.add('hidden');
            }, 300);
            
            // Unsubscribe from any active listeners associated with the modal
            if (MODAL_UNSUBSCRIBE_LISTENER) {
                MODAL_UNSUBSCRIBE_LISTENER();
            }
        }
        
        // --- Firestore Reference Helpers (Mocked/Assumed to Exist) ---
        function getUserProfileDocRef(uid) { return doc(USER_PROFILES_COLLECTION, uid); }
        function getFriendCodeDocRef(code) { return doc(FRIEND_CODES_COLLECTION, code); }
        function getDailyPhotoDocRef(postId) { return doc(DAILY_PHOTO_COLLECTION, postId); }
        
        /**
         * @brief Creates the HTML element for a photo thumbnail in the feed.
         */
        function createPhotoThumbnailElement(docId, data) {
             const thumb = document.createElement('div');
             thumb.classList.add('photo-thumbnail');
             thumb.setAttribute('data-photo-id', docId);
             thumb.addEventListener('click', () => openPhotoModal(docId)); // Assumed function
             
             thumb.innerHTML = `
                <img src="${data.url}" alt="${data.title}">
                <div class="overlay flex flex-col justify-end p-2">
                    <div class="flex justify-between items-center text-white">
                        <div class="flex items-center gap-2">
                            <span class="text-xs flex items-center"><i class="fas fa-heart text-red-400 mr-1"></i> <span class="heart-count-display">${formatCount(data.hearts?.length || 0)}</span></span>
                            <span class="text-xs flex items-center"><i class="fas fa-comment text-purple-400 mr-1"></i> <span class="comment-count-display">${formatCount(data.comments?.length || 0)}</span></span>
                        </div>
                    </div>
                </div>
                <div class="title-overlay">
                    <div class="title-text-container">
                        <span class="title-text-span">${data.title}</span>
                    </div>
                </div>
            `;
            return thumb;
        }

        // --- Feed Listener Management Logic (Refined Feed Listener Management) ---
        
        /**
         * @brief Sets up the real-time listener for the main photo feed based on the current mode.
         * @param {string} mode 'FRIENDS' or 'PUBLIC'.
         */
        function setupPostFeedListener(mode) {
            // 1. Unsubscribe from the existing listener to prevent resource leaks.
            // This is the core fix for Refined Feed Listener Management.
            if (UNSUBSCRIBE_POSTS_LISTENER) {
                UNSUBSCRIBE_POSTS_LISTENER();
            }

            const postsRef = collection(db, 'daily_photos');
            let q;

            if (mode === 'FRIENDS') {
                photoFeed.innerHTML = '<p class="text-gray-500 text-center p-4">Loading friends feed...</p>';
                if (CURRENT_FRIENDS.length === 0) {
                     photoFeed.innerHTML = '<p class="text-gray-500 text-center p-4">You have no friends yet. Add some to see their daily photos!</p>';
                     UNSUBSCRIBE_POSTS_LISTENER = () => {};
                     return;
                }
                // Friends query: creatorUid is in the current user's friends list
                // Firestore 'in' query supports up to 10 items, but for simplicity, we assume it works or use multiple 'where' clauses if needed.
                // Assuming CURRENT_FRIENDS is handled correctly to avoid exceeding limits (e.g., fetching a max number of friends).
                q = query(postsRef, 
                    where('creatorUid', 'in', CURRENT_FRIENDS.slice(0, 10)), // Limit to 10 UIDs for Firestore 'in' query limitation safety
                    orderBy('createdAt', 'desc'),
                    limit(50)
                );
            } else { // 'PUBLIC' Mode
                photoFeed.innerHTML = '<p class="text-gray-500 text-center p-4">Loading public feed...</p>';
                // Public query: Show all posts ordered by creation time
                q = query(postsRef, 
                    orderBy('createdAt', 'desc'),
                    limit(50)
                );
            }

            // 2. Setup the new listener
            UNSUBSCRIBE_POSTS_LISTENER = onSnapshot(q, (snapshot) => {
                const fragment = document.createDocumentFragment();
                // Process document changes (reuse existing logic from snippet)
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'removed') {
                         document.querySelector(`.photo-thumbnail[data-photo-id="${change.doc.id}"]`)?.remove();
                    } else {
                        const docId = change.doc.id;
                        const data = change.doc.data();
                        if (!data.title) return; // Skip posts without titles

                        // Try to reuse an existing element 
                        let thumb = document.querySelector(`.photo-thumbnail[data-photo-id="${docId}"]`);
                        if (thumb) {
                            // Update existing element properties (taken from snippet)
                            thumb.querySelector('.heart-count-display').innerHTML = formatCount(data.hearts?.length || 0);
                            thumb.querySelector('.comment-count-display').innerHTML = formatCount(data.comments?.length || 0);
                            thumb.querySelector('.title-text-span').textContent = data.title;
                        } else {
                            // Create a new element (assuming createPhotoThumbnailElement exists)
                            thumb = createPhotoThumbnailElement(docId, data);
                            // Simple prepend for new additions, or append for full rebuild
                            if (change.type === 'added' && change.newIndex === 0 && photoFeed.firstChild && photoFeed.firstChild.id !== 'no-posts-message') {
                                photoFeed.prepend(thumb);
                                return; // Skip full rebuild below
                            }
                        }
                        fragment.appendChild(thumb);
                    }
                });
                
                // If a full rebuild is needed (initial load or non-prepending changes)
                if (fragment.children.length > 0 || snapshot.docChanges().length === 0) {
                    // 3. Clear the existing feed and replace it with the new, correct one
                    photoFeed.innerHTML = '';
                    photoFeed.appendChild(fragment);
                }


                if (photoFeed.children.length === 0) photoFeed.innerHTML = `<p id="no-posts-message" class="text-center text-gray-500 p-4">No photos found in the ${mode.toLowerCase()} feed.</p>`;

            }, (error) => {
                console.error("Feed listener error:", error);
                photoFeed.innerHTML = '<p class="text-red-400 text-center p-4">Error loading feed.</p>';
            });
        }
        
        // --- Visibility Toggle Logic ---

        function promptPublicDisclaimer() {
            disclaimerModal.classList.remove('hidden', 'opacity-0');
            setTimeout(() => disclaimerModal.classList.add('opacity-100'), 10);
        }

        function hidePublicDisclaimer() {
            disclaimerModal.classList.remove('opacity-100');
            setTimeout(() => disclaimerModal.classList.add('hidden', 'opacity-0'), 300);
        }

        /**
         * Sets the state, saves it, hides the modal, and performs the mode switch.
         */
        function acceptPublicDisclaimer() {
            PUBLIC_MODE_ACCEPTED = true;
            localStorage.setItem('PUBLIC_MODE_ACCEPTED', 'true');
            hidePublicDisclaimer();
            performModeSwitch('PUBLIC');
        }

        /**
         * Updates the UI elements for the visibility toggle.
         */
        function updateToggleUI() {
            if (CURRENT_FEED_MODE === 'PUBLIC') {
                toggleIcon.className = 'fas fa-globe';
                toggleText.textContent = 'Public';
                toggleFeedBtn.classList.add('btn-primary-override');
            } else {
                toggleIcon.className = 'fas fa-user-friends';
                toggleText.textContent = 'Friends';
                toggleFeedBtn.classList.remove('btn-primary-override');
            }
        }

        /**
         * Executes the switch between feed modes.
         * @param {string} newMode 'FRIENDS' or 'PUBLIC'.
         */
        function performModeSwitch(newMode) {
            CURRENT_FEED_MODE = newMode;
            setupPostFeedListener(newMode);
            updateToggleUI();
        }
        
        /**
         * The main handler for the visibility toggle button.
         */
        function toggleFeedMode() {
            if (CURRENT_FEED_MODE === 'FRIENDS') {
                // Switching to Public: Check disclaimer status
                if (PUBLIC_MODE_ACCEPTED || localStorage.getItem('PUBLIC_MODE_ACCEPTED') === 'true') {
                    performModeSwitch('PUBLIC');
                } else {
                    promptPublicDisclaimer();
                }
            } else {
                // Switching to Friends (always allowed)
                performModeSwitch('FRIENDS');
            }
        }
        
        // --- Post Reporting Logic ---

        /**
         * @brief Handles reporting a post.
         * @param {string} postId The ID of the post to report.
         */
        async function handleReportPost(postId) {
            if (!auth.currentUser) return showCustomModal("Error", "You must be logged in to report a post.");
            
            const postRef = getDailyPhotoDocRef(postId);
            const reportedRef = doc(REPORTED_POSTS_COLLECTION, postId);
            
            try {
                // 1. Check if post is already reported by current user
                const postSnap = await getDoc(postRef);
                const postData = postSnap.data();

                if (postData?.reportedBy?.includes(auth.currentUser.uid)) {
                    return showCustomModal("Report Status", "You have already reported this post. Thank you!");
                }
                
                // Get fresh data if it was just reported
                let dataToStore = postData;
                if (!dataToStore) {
                    showCustomModal("Error", "Post not found or already deleted.");
                    return;
                }

                // 2. Mark the original post as reported (makes it unable to delete)
                await updateDoc(postRef, {
                    isReported: true,
                    reportedBy: arrayUnion(auth.currentUser.uid), // Track who reported it
                });

                // 3. Create/update a separate record for admin review 
                const reportedSnap = await getDoc(reportedRef);
                
                if (reportedSnap.exists()) {
                     await updateDoc(reportedRef, {
                        reportCount: reportedSnap.data().reportCount + 1,
                        updatedAt: serverTimestamp(),
                        reporterUid: arrayUnion(auth.currentUser.uid)
                     });
                } else {
                     await setDoc(reportedRef, {
                        ...dataToStore,
                        originalPostId: postId,
                        reportedAt: serverTimestamp(),
                        reporterUid: [auth.currentUser.uid],
                        reportCount: 1,
                        status: 'pending_review'
                    });
                }

                showCustomModal("Post Reported", "Thank you for reporting. This post is now under review. The original user cannot delete reported posts.", "success");
                closePhotoModal();
            } catch (error) {
                console.error("Error reporting post:", error);
                showCustomModal("Error", `Failed to report post: ${error.message}`);
            }
        }
        
        // --- Modal Content Logic (Mocked to show where the new buttons are attached) ---
        // NOTE: This assumes the original file has an `openPhotoModal` function which this new logic hooks into.
        
        // function openPhotoModal(postId) {
        //     // ... existing logic to fetch post data (photoData) ...
        // 
        //     // After successful fetch:
        //     const isOwner = photoData.creatorUid === auth.currentUser.uid;
        //     const isReported = photoData.isReported;
        //     
        //     // Update the delete button visibility
        //     const deleteTriggerBtn = document.getElementById('delete-post-trigger-btn');
        //     if (isOwner && !isReported) {
        //         deleteTriggerBtn.classList.remove('hidden');
        //     } else {
        //         deleteTriggerBtn.classList.add('hidden');
        //     }
        //
        //     // Update the report status badge
        //     const reportStatusBadge = document.getElementById('report-status-badge');
        //     if (isReported) {
        //         reportStatusBadge.classList.remove('hidden');
        //     } else {
        //         reportStatusBadge.classList.add('hidden');
        //     }
        //
        //     // Set the postId on the report button
        //     document.getElementById('report-post-btn').dataset.postId = postId;
        //
        //     // ... existing logic to show the modal ...
        // }

        // --- Event Listeners and Initialization ---
        
        function setupListeners() {
            // NEW: Toggle Button Listener
            if(toggleFeedBtn) toggleFeedBtn.addEventListener('click', toggleFeedMode);

            // NEW: Disclaimer Accept Button Listener
            if(acceptDisclaimerBtn) disclaimerModal.addEventListener('click', (e) => {
                if(e.target.id === 'accept-public-feed-button') acceptPublicDisclaimer();
                // Prevent closing by clicking outside the modal content
                else e.stopPropagation();
            });

            // Close disclaimer modal if backdrop is clicked (but not the content itself)
            if(disclaimerModal) disclaimerModal.addEventListener('click', hidePublicDisclaimer);
            
            // Photo Modal Click Listener (Adding Report/Delete logic)
            photoModalContainer.addEventListener('click', async (e) => {
                
                // Existing listeners (toggle-fullscreen-btn, heart-btn, send-comment-btn, close-photo-modal-btn) 
                // ... are assumed to be handled correctly in the original file. ...

                // Delete Button Trigger
                const deleteTriggerBtn = e.target.closest('#delete-post-trigger-btn');
                if (deleteTriggerBtn) {
                     document.getElementById('delete-confirmation-view').classList.remove('hidden');
                     document.getElementById('photo-view-main').style.opacity = '0.5';
                }

                // Delete Button Cancel
                const cancelDeleteBtn = e.target.closest('#cancel-delete-btn');
                if (cancelDeleteBtn) {
                     document.getElementById('delete-confirmation-view').classList.add('hidden');
                     document.getElementById('photo-view-main').style.opacity = '1';
                }

                // NEW: Delete Confirmation Logic (Modified to check for isReported)
                const confirmDelete = e.target.closest('#confirm-delete-btn');
                if (confirmDelete) {
                    const currentPostId = document.getElementById('heart-btn')?.dataset.postId; // Assuming post ID is stored here
                    if (!currentPostId) return;

                    // Check for report status before deleting (Makes it unable to delete)
                    const postDocSnap = await getDoc(getDailyPhotoDocRef(currentPostId));
                    if (postDocSnap.data()?.isReported) {
                         showCustomModal("Deletion Blocked", "This post has been reported and cannot be deleted until the report is resolved.");
                         // Hide the confirmation view and restore main view
                         document.getElementById('delete-confirmation-view').classList.add('hidden');
                         document.getElementById('photo-view-main').style.opacity = '1';
                         return;
                    }
                    
                    if (currentPostId) {
                        deleteDoc(getDailyPhotoDocRef(currentPostId))
                        .then(() => { 
                            closePhotoModal(); 
                            showMessage(uploadMessage, 'Post deleted.', 'success'); 
                        })
                        .catch(error => showCustomModal("Deletion Error", `Failed to delete post: ${error.message}`));
                    } else { showCustomModal("Deletion Error", "Could not find post ID to delete."); }
                }
                
                // NEW: Report Post Button Listener
                const reportBtn = e.target.closest('#report-post-btn');
                if (reportBtn) {
                    handleReportPost(reportBtn.dataset.postId);
                }
            });
            
            // ... (Other existing listeners)
        }
        
        /**
         * @brief Main authentication check and app initialization.
         */
        async function initializeAuth() {
            // Load disclaimer state from local storage
            PUBLIC_MODE_ACCEPTED = localStorage.getItem('PUBLIC_MODE_ACCEPTED') === 'true';
            updateToggleUI(); // Initialize the UI state

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = '../index.html'; 
                } else {
                    // Fetch user profile and friends list
                    const userProfileRef = getUserProfileDocRef(user.uid);
                    const userProfileSnap = await getDoc(userProfileRef);
                    
                    const profileData = userProfileSnap.data();
                    CURRENT_USERNAME = profileData?.username || 'DailyUser';
                    CURRENT_FRIENDS = profileData?.friends || [];
                    
                    // The following functions are assumed to exist in the original file:
                    // setupDailyPostsListener(); // Listener for the user's daily posts panel
                    // setupFriendCodeLogic(user); // Logic for friend codes/requests
                    // setupFriendsListListener(user); // Listener for the friends list panel
                    
                    // NEW: Initialize the main feed listener based on the initial mode
                    setupPostFeedListener(CURRENT_FEED_MODE); 

                    loadingScreen.style.display = 'none';
                    pageContent.classList.remove('hidden');
                    pageContent.style.display = 'block';
                    setupListeners(); // Setup event listeners after DOM is visible
                }
            });
        }
        
        // Start the application initialization
        initializeAuth();
    </script>
</body>
</html>
